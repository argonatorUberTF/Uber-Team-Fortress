void () playerfob_think;
void() attachplayerfob;
void() KickHead;
void () setup_strcat;
void() FixSoundCrap;
void () AC_Eject;
void() PlayerPostThink;
void () Stinger_TryLock;
void (float modelindex_ac) AC_MaintainAircraft;
float FTE_Server;
void (entity rank_ent) Rank_FindStats;
void (entity rank_ent) Rank_UpdateStats;
void (entity rank_ent, float addscore) Rank_AddRank;
void (entity rank_ent, float addscore) Rank_AddFrags;
void (entity rank_ent, float addscore) Rank_AddFers;
void (entity rank_ent, float addscore) Rank_AddDeaths;
void () SetUpPrematch;
void() set_suicide_frame;
void() player_touch;
void() TeamFortress_SetEquipment;
void() TeamFortress_SetHealth;
void(string halias, float himpulse1, float himpulse2) TeamFortress_Alias;
void() PlayerDie;
void(entity attacker) fertimer;
void () W_WeaponFrame;
void() W_SetCurrentAmmo;
void() player_pain;
void() player_stand1;
void (vector org) spawn_tfog;
void (vector org, entity death_owner) spawn_tdeath;
void() TeamFortress_MOTD;
void() TeamFortress_CheckTeamCheats;
float(float tno) TeamFortress_TeamGetColor;
void(entity Viewer, float pc, float rpc, float xavior_Var) TeamFortress_PrintClassName;
void() TeamFortress_RemoveTimers;
void(float Suicided) TeamFortress_SetupRespawn;
void() TeamFortress_ShowTF;
float(float pc) IsLegalClass;
void() SetupTeamEqualiser;
void(entity p) SetTeamName;
void () Service_Grapple;
void(entity AD) ParseTFDetect;
entity(float ino) Finditem;
void(entity Item, entity AP, entity Goal) tfgoalitem_GiveToPlayer;
void(entity Goal, entity AP, entity ActivatingGoal) AttemptToActivate;
void() CTF_FlagCheck;
void () exit_vehicle;
void () Sub_Speed;
void() info_intermission = 
{
	if (CheckExistence() == 0)
	{
		dremove(self);
		return;
	}
};
void() SetChangeParms = 
{
	if (self.health <= 0)
	{
		SetNewParms();
		return;
	}
	self.items = self.items - (self.items & (131072 | 262144 | 524288 | 1048576 | 2097152 | 4194304));
#ifndef mtf_coop
	if (self.health > 100)
	{
		self.health = 100;
	}
#endif
	if (self.health < 50)
	{
		self.health = 50;
	}
	parm1 = self.items;
	parm2 = self.health;
	parm3 = self.armorvalue;
	if (self.ammo_shells < 25)
	{
		parm4 = 25;
	}
	else
	{
		parm4 = self.ammo_shells;
	}
	parm5 = self.ammo_nails;
	parm6 = self.ammo_rockets;
	parm7 = self.ammo_cells;
	parm8 = self.current_weapon;
	parm9 = self.armortype * 100;
	parm10 = toggleflags;
	parm11 = 0;
	parm12 = 0;
	parm13 = self.StatusBarRes;
	parm14 = self.StatusBarSize;
};
void() SetNewParms = 
{
	parm1 = 0;
	parm2 = 100;
	parm3 = 0;
	parm4 = 25;
	parm5 = 0;
	parm6 = 0;
	parm6 = 0;
	parm8 = TF_FLARE_OFF;
	parm9 = 0;
	parm10 = 0;
	parm11 = 0;
	parm12 = 0;
	parm13 = 0;
	parm14 = 0;
};
void() autoteam_think = 
{
	toggleflags = toggleflags | 64;
	dremove(self);
};
void() DecodeLevelParms = 
{
	local string st;
	local entity ent;
	local float autoteam_time;
	if (serverflags)
	{
		if (world.model == "maps/start.bsp")
		{
			SetNewParms();
		}
	}
#ifdef mtf_coop_bbelief
	if (!deathmatch)
	{
		if ((world.model == "maps/bbelief1.bsp"))
		{
			SetNewParms ();
		}
		else
		{
			if ((world.model == "maps/bbstart.bsp"))
			{
				SetNewParms ();
			}
		}
	}
#endif
	self.items = parm1;
	self.health = parm2;
	self.armorvalue = parm3;
	self.ammo_shells = parm4;
	self.ammo_nails = parm5;
	self.ammo_rockets = parm6;
	self.ammo_cells = parm7;
	self.current_weapon = parm8;
	self.armortype = parm9 * 0.010000;

	if (toggleflags == 0)
	{
#ifdef mtf_coop
		ParseTFDetect(self);
#endif
		toggleflags = parm10;
		allow_hook = 0;
		invis_only = 0;
		if (coop || !deathmatch)
		{
			toggleflags = toggleflags | TF_FLARE_OFF;
		}
		nextmap = mapname;
		allow_hook = TF_FLARE_OFF;
		ent = find(world, classname, "info_tfdetect");
		if (ent != world)
		{
			if (teamplay == 0)
			{
				cvar_set("teamplay", "21?TeamFortress");
			}
			ParseTFDetect(ent);
			if (number_of_teams <= 0 || number_of_teams >= 5)
			{
				number_of_teams = 4; //why only 2 teams there are 4 team teamfortress maps. -arg
			}
		}
		else
		{
			ent = find(world, classname, "info_player_team1");
			if (ent != world || CTF_Map == TF_FLARE_OFF)
			{
#ifdef mtf_coop
if (!coop) {
#endif
				CTF_Map = TF_FLARE_OFF;
				if (teamplay == 0)
				{
					cvar_set("teamplay", "21?TeamFortress");
				}
				ent = spawn();
				ent.nextthink = time + 30;
				ent.think = CTF_FlagCheck;
				number_of_teams = 2; // because this is for ctf only maps. -arg
#ifdef mtf_coop
}
#endif
			}
			else
			{
				number_of_teams = 4;  //I think this is right, regardless of whatever map -arg
//however the map has to have a teamspawn for teams 1-4 at least 2 teams.
			}
#ifndef mtf_coop
			cvar_set("sv_aim", "1");
#endif
			team1lives = -1;
			team2lives = -1;
			team3lives = -1;
			team4lives = -1;
			illegalclasses1 = 0;
			illegalclasses2 = 0;
			illegalclasses3 = 0;
			illegalclasses4 = 0;
			team1maxplayers = 100;
			team2maxplayers = 100;
			team3maxplayers = 100;
			team4maxplayers = 100;
			civilianteams = 0;
		}
		bprint(2, "Mapname: ");
		bprint(2, mapname);
		bprint(2, "\n");
		SetupTeamEqualiser();
			toggleflags = toggleflags - (toggleflags & 128);
		toggleflags = toggleflags | 2;
		st = infokey(world, "temp1");
		toggleflags = toggleflags | 256 | stof(st);
		autoteam_time = 30;
		st = infokey(world, "a");
		if (st == string_null)
		{
			st = infokey(world, "autoteam");
		}
		if (st == "on")
		{
			toggleflags = toggleflags | 64;
		}
		else
		{
			if (st == "off")
			{
				toggleflags = toggleflags - (toggleflags & 64);
			}
			else
			{
				if (stof(st) != 0)
				{
					toggleflags = toggleflags | 64;
					autoteam_time = stof(st);
				}
			}
		}
		st = infokey(world, "t");
		if (st == string_null)
		{
			st = infokey(world, "teamfrags");
		}
		if (st == "on")
		{
			toggleflags = toggleflags | 128;
		}
		else
		{
			if (st == "off")
			{
				toggleflags = toggleflags - (toggleflags & 128);
			}
		}
		st = infokey(world, "g");
		if (st == string_null)
		{
			st = infokey(world, "grapple");
		}
		if (st == "off")
		{
			allow_hook = 0;
		}
		if (!(toggleflags & 1024) && st != "on")
		{
			allow_hook = 0;
		}
		st = infokey(world, "spy");
		if (st == "off")
		{
			spy_off = TF_FLARE_OFF;
		}
		st = infokey(world, "s");
		if (st == string_null)
		{
			st = infokey(world, "spyinvis");
		}
		if (st == "on" || (toggleflags & 512))
		{
			invis_only = TF_FLARE_OFF;
		}
		else
		{
			if (st == "off")
			{
				invis_only = 0;
			}
		}
		st = infokey (world, "spycam");
		if (((st == "on") || (st == "1")))
		{
			spycam = 1.000000;
		}
		else
		{
			spycam = 0.000000;
		}
		st = infokey (world, "teamchange");
		if (((st == "on") || (st == "1")))
		{
			allowchange = 1;
		}
		else
		{
			allowchange = 1; // can't find the code so I hard code the switch. -arg
		}
		st = infokey (world, "new_armor");
		if (((st == "on") || (st == "1")))
		{
			spy_armor = 1;
		}
		else
		{
			spy_armor = 0;
		}
		st = infokey (world, "chute");
		if (((st == "off") || (st == "0")))
		{
			allow_chute = 0;
		}
		else
		{
			allow_chute = 1;
		}
		st = infokey (world, "scout_bat");
		if (((st == "off") || (st == "0")))
		{
			allow_bat = 0;
		}
		else
		{
			allow_bat = 1;
		}
		st = infokey (world, "self_flash");
		if (((st == "on") || (st == "1")))
		{
			self_flash = 1;
		}
		else
		{
			self_flash = 0;
		}
		st = infokey (world, "conctype");
		if (((st == "old") || (st == "1")))
		{
			oldconc = 1;
		}
		else if (st == "2")
		{
			oldconc = 2;
		}
		else
		{
			oldconc = 0;
		}
		st = infokey (world, "r_fer");
		if (st != "off")
		{
			record_fer = stof(st);
			if (record_fer < 1)
				record_fer = 3;
		}
		st = infokey (world, "r_frags");
		if (st != "off")
		{
			if (record_frags < 1)
				record_frags = 30;
			record_frags = stof(st);
		}
		st = infokey (world, "old20mm");
		if (((st == "on") || (st == "1")))
		{
			old20mm = 1;
		}
		else
		{
			old20mm = 0;
		}
		st = infokey (world, "pmonsters");
		if (((st == "1")))
		{
			prematchmonsters = 1;
		}
		if (((st == "2")))
		{
			prematchmonsters = 2;
		}
		else
		{
			prematchmonsters = 0;
		}
		st = infokey (world, "spyjumpoption");
		if (((st == "on") || (st == "1")))
		{
			spyjumpoption = 1.000000;
		}
		else
		{
			spyjumpoption = 0.000000;
		}
		st = infokey (world, "olddisarm");
		if (((st == "on") || (st == "1")))
		{
			olddisarm = 1.000000;
		}
		else
		{
			olddisarm = 0.000000;
		}
		st = infokey(world, "sticky");
		if (st == "")
		{
			localcmd ("localinfo sticky 0\n");
		}
		st = infokey(world, "allowvote");
		if (st == "")
		{
			localcmd ("localinfo allowvote 1\n");
		}
		st = infokey(world, "newbalance");
		if (st == "")
		{
			localcmd ("localinfo newbalance 1\n");
		}
		st = infokey (world, "drop2");
		if ((st == "off"))
		{
			drop2 = 0.000000;
		}
		else
		{
			drop2 = 1.000000;
		}
		st = infokey (world, "laymode");
		if (st == "0")
		{
			laymode = 0;
		}
		else
		{
			if (st == "2")
			{
				laymode = 2;
			}
			else
				laymode = 1;
		}
		st = infokey (world, "dropgrens");
		if (((st == "on") || (st == "1")))
		{
			sr_dropgrens = 1.000000;
		}
		else
		{
			sr_dropgrens = 0.000000;
		}
		st = infokey (world, "sr_gren1");
		sr_gren1 = stof (st);
		st = infokey (world, "sr_gren2");
		sr_gren2 = stof (st);
		if ((sr_gren1 <= 0.000000))
		{
			sr_gren1 = 10.000000;
		}
		if ((sr_gren2 <= 0.000000))
		{
			sr_gren2 = 10.000000;
		}
		st = infokey(world, "prematch");
		prematch = stof(st);
		if (prematch > 0)
		{
			SetUpPrematch();
		}
		st = infokey(world, "cr_scout");
		cr_scout = stof(st);
		st = infokey(world, "cr_sniper");
		cr_sniper = stof(st);
		st = infokey(world, "cr_soldier");
		cr_soldier = stof(st);
		st = infokey(world, "cr_demoman");
		cr_demoman = stof(st);
		st = infokey(world, "cr_medic");
		cr_medic = stof(st);
		st = infokey(world, "cr_hwguy");
		cr_hwguy = stof(st);
		st = infokey(world, "cr_pyro");
		cr_pyro = stof(st);
		st = infokey(world, "cr_spy");
		cr_spy = stof(st);
		st = infokey(world, "cr_engineer");
		cr_engineer = stof(st);
		if ( (cr_scout != 0) && (cr_sniper != 0) && (cr_soldier != 0) && (cr_demoman != 0) && (cr_medic != 0) && (cr_hwguy != 0) && (cr_pyro != 0) && (cr_spy != 0) && (cr_engineer != 0) )
			cr_engineer = 0;
		st = infokey (world, "clr_enabled");
		if ((st == "on"))
		{
			clr_enabled = 1.000000;
		}
		else
		{
			if ((st == "1"))
			{
				clr_enabled = 1.000000;
			}
			else
			{
				clr_enabled = 0.000000;
			}
		}
		st = infokey(world, "airscout");
		if (st == "off")
		{
			airscout = 0;
		}
		else
		{
			airscout = TF_FLARE_OFF;
		}
		st = infokey(world, "headkick");
		if (st == "off")
		{
			headkick = 0;
		}
		else
		{
			headkick = TF_FLARE_OFF;
		}
		st = infokey (world, "coloredlights");
		if ((st == "on"))
		{
			coloredlights = 1.000000;
		}
		else
		{
			coloredlights = 0.000000;
		}
		st = infokey(world, "drop3");
		if (st == "off")
		{
			drop3 = 0;
		}
		else
		{
			drop3 = TF_FLARE_OFF;
		}
		st = infokey (world, "drop2");
		if ((st == "off"))
		{
			drop2 = 0.000000;
		}
		else
		{
			drop2 = 1.000000;
		}
		st = infokey (world, "drop1");
		if ((st == "off"))
		{
			drop1 = 0.000000;
		}
		else
		{
			drop1 = 1.000000;
		}

		st = infokey(world, "footsteps");
		if (st == "off")
		{
			footsteps = 0;
		}
		else
		{
			footsteps = TF_FLARE_OFF;
		}
		st = infokey(world, "old_gl");
		if (st == "off")
		{
			old_gl = 0;
		}
		else
		{
			old_gl = TF_FLARE_OFF;
		}
		st = infokey(world, "exec_class");
		if (st != "off")
		{
			exec_class = TF_FLARE_OFF;
		}
		else
		{
			exec_class = 0;
		}
		st = infokey(world, "rd");
		if (st == string_null)
		{
			st = infokey(world, "respawn_delay");
		}
		respawn_delay_time = stof(st);
		if (respawn_delay_time)
		{
			toggleflags = toggleflags | 4;
		}
		if (toggleflags & 4 && respawn_delay_time == 0)
		{
			respawn_delay_time = 5;
		}
		if (toggleflags & 64)
		{
			toggleflags = toggleflags - (toggleflags & 64);
			ent = spawn();
			ent.nextthink = time + autoteam_time;
			ent.think = autoteam_think;
		}
	}
	if (parm11)
	{
		self.tfstate = parm11;
	}
	if (self.playerclass == 0)
	{
		self.playerclass = parm12;
	}
	if (parm13)
	{
		self.StatusBarRes = parm13;
	}
	if (parm14)
	{
		self.StatusBarSize = parm14;
	}
	newmis = spawn();
	newmis.classname = "timer";
	newmis.nextthink = time + 1;
	newmis.enemy = self;
	newmis.think = FixSoundCrap;
};
float /*WARNING: could not determine return type*/ (entity _p_5763) IsLegalClient =
{
	local string _l_5764;
	local string _l_5765;
	local string _l_5766;
	local string _l_5767;
	_l_5766 = infokey (_p_5763, "*client");
	if ((_l_5766 == ""))
	{
		_l_5766 = infokey (_p_5763, "*z_ver");
		if ((_l_5766 == ""))
		{
			_l_5766 = infokey (_p_5763, "*FuhQuake");
			if ((_l_5766 != ""))
			{
				_l_5764 = "*FuhQuake";
			}
		}
		else
		{
			_l_5764 = "*z_ver";
		}
	}
	else
	{
		_l_5764 = "*client";
	}
	if ((_l_5764 == ""))
	{
		return (0.000000);
	}
	_l_5765 = infokey (_p_5763, _l_5764);
	_l_5766 = infokey (world, "clr_client1n");
	_l_5767 = infokey (world, "clr_client1v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client2n");
	_l_5767 = infokey (world, "clr_client2v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client3n");
	_l_5767 = infokey (world, "clr_client3v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client4n");
	_l_5767 = infokey (world, "clr_client4v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client5n");
	_l_5767 = infokey (world, "clr_client5v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client6n");
	_l_5767 = infokey (world, "clr_client6v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client7n");
	_l_5767 = infokey (world, "clr_client7v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client8n");
	_l_5767 = infokey (world, "clr_client8v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client9n");
	_l_5767 = infokey (world, "clr_client9v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	_l_5766 = infokey (world, "clr_client10n");
	_l_5767 = infokey (world, "clr_client10v");
	if (((_l_5764 == _l_5766) && (_l_5765 == _l_5767)))
	{
		return (1.000000);
	}
	return (0.000000);
};
#ifdef HALFLIFE
void (string str_a, string str_b) changelevel2 =
{
	if (landmarked) {
		changelevel_save(str_a, str_b);	// save the map (FTE only)
		intermission_running = 0;
		landmarked = 0;
	}
	else
		changelevel(str_a);//changelevel2(str_a, str_b);		// save the level damnit! >:0
};
#endif
void() TF_MovePlayer = 
{
	local entity place;
	place = FindNextIntermission(self.observer_list);
	self.observer_list = place;
	setorigin(self, place.origin + '0 0 1');
	self.angles = place.angles;
	self.fixangle = TF_FLARE_OFF;
};
void() ExitIntermission = 
{
	dprint("Exiting intermission...\n");
	if (deathmatch)
	{
		dprint("Exit Intermission in Deathmatch.\n");
		GotoNextMap();
		return;
	}
	intermission_exittime = time + TF_FLARE_OFF;
	intermission_running = intermission_running + TF_FLARE_OFF;
	if (intermission_running == 2)
	{
#ifdef mtf_coop
		if ((world.model == "maps/e1m7.bsp"))
		{
			WriteByte (MSG_ALL, SVC_CDTRACK);
			WriteByte (MSG_ALL, FL_SWIM);
			if (!cvar ("registered"))
			{
				WriteByte (MSG_ALL, SVC_FINALE);
				WriteString (MSG_ALL, "As the corpse of the monstrous entity\nChthon sinks back into the lava whence\nit rose, you grip the Rune of Earth\nMagic tightly. Now that you have\nconquered the Dimension of the Doomed,\nrealm of Earth Magic, you are ready to\ncomplete your task in...");
			}
			else
			{
				WriteByte (MSG_ALL, SVC_FINALE);
				WriteString (MSG_ALL, "As the corpse of the monstrous entity\nChthon sinks back into the lava whence\nit rose, you grip the Rune of Earth\nMagic tightly. Now that you have\nconquered the Dimension of the Doomed,\nrealm of Earth Magic, you are ready to\ncomplete your task. A...");
			}
			return;
		}
		else
		{
#endif
			if (world.model == "maps/e2m6.bsp")
			{
				WriteByte(2, 31);
				WriteString(2, "The Rune of Black Magic throbs evilly in\nyour hand and whispers dark thoughts\ninto your brain. You learn the inmost\nlore of the Hell-Mother; Shub-Niggurath!\nYou now know that she is behind all the\nterrible plotting which has led to so\nmuch death and horror. But she is not\ninviolate! Armed with this Rune, you\nrealize that once all four Runes are\ncombined, the gate to Shub-Niggurath's\nPit will open, and you can face the\nWitch-Goddess herself in her frightful\notherworld cathedral.");
				return;
			}
			else
			{
				if (world.model == "maps/e3m6.bsp")
				{
					WriteByte(2, 31);
					WriteString(2, "The charred viscera of diabolic horrors\nbubble viscously as you seize the Rune\nof Hell Magic. Its heat scorches your\nhand, and its terrible secrets blight\nyour mind. Gathering the shreds of your\ncourage, you shake the devil's shackles\nfrom your soul, and become ever more\nhard and determined to destroy the\nhideous creatures whose mere existence\nthreatens the souls and psyches of all\nthe population of Earth.");
					return;
				}
				else
				{
					if (world.model == "maps/e4m7.bsp")
					{
						WriteByte(2, 31);
						WriteString(2, "Despite the awful might of the Elder\nWorld, you have achieved the Rune of\nElder Magic, capstone of all types of\narcane wisdom. Beyond good and evil,\nbeyond life and death, the Rune\npulsates, heavy with import. Patient and\npotent, the Elder Being Shub-Niggurath\nweaves her dire plans to clear off all\nlife from the Earth, and bring her own\nfoul offspring to our world! For all the\ndwellers in these nightmare dimensions\nare her descendants! Once all Runes of\nmagic power are united, the energy\nbehind them will blast open the Gateway\nto Shub-Niggurath, and you can travel\nthere to foil the Hell-Mother's plots\nin person.");
						return;
					}
					else 
					{
#ifdef mtf_coop_nehahra
						if ((world.model == "maps/nehend.bsp"))
						{
							WriteByte (MSG_ALL, SVC_CDTRACK);
							WriteByte (MSG_ALL, 3);
							WriteByte (MSG_ALL, SVC_FINALE);
							WriteString (MSG_ALL, "Wrung from the blood of a thousand\ndamned, the blood of Max seeps into the\ncold metal floor of his otherworld\narena and the spirits of the innumerable\nslip away from his lifeless hands.\nTheir liberated voices echo off the once\ndispassionate industrial walls and chase\nthe chill of fear from your soul.\nEven knowing your life on Earth awaits\nyou in the blink of an eye, you derive\nlittle comfort from your survival.\nAlthough the twisted immortal lies dead,\na gaunt proverb parades through your\nmind as if to taunt you with\nthe possibilities.\n\n'Death is just the beginning.'");
							return;
						}
						else
						{
							if ((world.model == "maps/nehahra.bsp"))
							{
							WriteByte (MSG_ALL, SVC_CDTRACK);
							WriteByte (MSG_ALL, 3);
							WriteByte (MSG_ALL, SVC_FINALE);
							WriteString (MSG_ALL, "Paralyzed, courage lost to quicksand\nand senses deafened by the roar of \nthe daemonic tornado, your heart  \nscreams with rage, your lungs labor \nfor air, as your hands wildly dance,\ngroping for the nothing.  Leaping,\nfalling, flying madly through strings of\ninner spaces, soaring mindlessly\nthrough Cimmerian abysses on cacophonous\nwings of emotion and infinite sound;\nmadly plunging past unnumbered shapes of\nshadow beyond all memory; all these\nfantastic things can not overwhelm\nthe maniacal laughter of the dark\nimmortal and his commanding hands\nthat pull you through the\nblack aether to some unknown end.\n\nThe beast Nehahra is laid to rest,\nbut your troubles are far from over.");
							return;
							}
							else
							{
								if ((world.model == "maps/neh1m3.bsp"))
								{
							WriteByte (MSG_ALL, SVC_CDTRACK);
							WriteByte (MSG_ALL, 3);
							WriteByte (MSG_ALL, SVC_FINALE);
									WriteString (MSG_ALL, "Odds weigh against you but luck is\non your side. Free from the death\nenveloping Forge City, you have only a\nquestion mark lingering in the air\nto look forward to.  Not knowing what to\nexpect, not knowing where you're going\nor how to get there, y...");
									return;
								}
								else
								{
									if ((world.model == "maps/neh1m9.bsp"))
									{
							WriteByte (MSG_ALL, SVC_CDTRACK);
							WriteByte (MSG_ALL, 3);
							WriteByte (MSG_ALL, SVC_FINALE);
										WriteString (MSG_ALL, "The battle cries of the vile Vores\nand the strange utterances of the\nbizarre race of Tsemoch echo through\nyour thoughts.  Amazed you survived this\nlong, you leave the last threads of\nhuman civilization behind and boldly\nventure into the alien ou...");
										return;
									}
									else
									{
										if ((world.model == "maps/neh3m4.bsp"))
										{
							WriteByte (MSG_ALL, SVC_CDTRACK);
							WriteByte (MSG_ALL, 3);
							WriteByte (MSG_ALL, SVC_FINALE);
											WriteString (MSG_ALL, "The bitter taste of adrenaline lingers\non your lips like Stygian wine and the\nblood staining your hands feels no\nless cold than your own that rushes\nthrough your veins and hammers your\nears long after the warped Archgaunt\nfell.  You shudder from...");
											return;
										}
						else
						{
#endif
						if ((world.model == "maps/qtfin3.bsp"))
						{
							WriteByte (MSG_ALL, SVC_CDTRACK);
							WriteByte (MSG_ALL, 3);
							WriteByte (MSG_ALL, SVC_FINALE);
							WriteString (MSG_ALL, "Just when you thought Azoth had once\nagain taken the upper hand, a horrendous\nscream followed by an explosion of\nbloody gibs rains down from the vacuous\nblack sky. You barely have time to dodge\nhis plummeting lower trunk and legs but\nyou lunge a...");
							return;
						}
						else
						{
							if ((world.model == "maps/qte2m4.bsp"))
							{
								WriteByte (MSG_ALL, SVC_CDTRACK);
								WriteByte (MSG_ALL, 3);
								WriteByte (MSG_ALL, SVC_FINALE);
								WriteString (MSG_ALL, "The ferrous whisper of the teleporter\nincreases to a roar as you step through.\nYou send a prayer of thanks out into\nthe multiverse that the Juggers did not\nreceive their arcane intelligence boost.\nSmart behemoths are too frightening to\ncontempla...");
								return;
							}
							else
							{
								if ((world.model == "maps/qte1m5.bsp"))
								{
									WriteByte (MSG_ALL, SVC_CDTRACK);
									WriteByte (MSG_ALL, 3);
									WriteByte (MSG_ALL, SVC_FINALE);
									WriteString (MSG_ALL, "\nStanding before the teleport, your eyes\nsmart and squint through the salty slick\nof sweat and venomous spit. You don't\nknow what is worse, the ache of battle\nor the torrid sulphurous miasma of this\nmolten lair. The Uberscrag imploded\nbefore you...");
									return;
								}
							}
						}
					}
				}
			}
#ifdef mtf_coop
#ifdef mtf_coop_nehahra
		} } } } }
#endif
		}
#endif
#ifdef mtf_coop_hipnotic
		if ((world.model == "maps/hip1m3.bsp"))	// xav: really hip1m4, but that dont work :(
		{
			WriteByte (MSG_ALL, SVC_CDTRACK);
			WriteByte (MSG_ALL, 3);
			WriteByte (MSG_ALL, SVC_FINALE);
			WriteString (MSG_ALL, "Deep within the bowels of the\nResearch Facility, you discover the\npassage that the followers of Quake\nhave used to enter our world.\nThe bastards used some type of\ngigantic teleporter to overload\none of our own slipgates!  As long as\nthis portal ...");
			return;
		}
		else
		{
			if ((world.model == "maps/hip2m5.bsp"))
			{
				WriteByte (MSG_ALL, SVC_CDTRACK);
				WriteByte (MSG_ALL, 3);
				WriteByte (MSG_ALL, SVC_FINALE);
				WriteString (MSG_ALL, "After destroying the power generator,\nyou pass beyond the gate of Mortum's\nKeep.  A wave of nausea suddenly flows\nover you and you find yourself cast\nout into a liquid void.  You float\nlifelessly, yet aware, in a lavender\nsea of energy.");
				return;
			}
			else
			{
				if ((world.model == "maps/hipend.bsp"))
				{
					WriteByte (MSG_ALL, SVC_CDTRACK);
					WriteByte (MSG_ALL, 3);
					WriteByte (MSG_ALL, SVC_FINALE);
					WriteString (MSG_ALL, "After the last echoes of Armagon's\ndeath yell fade away, you breathe a\nheavy sigh of relief.  With the loss\nof his magic, Armagon's fortress\nbegins to collapse.  The rift he\ncreated to send his grisly troops\nthrough time slowly closes and seals\n...");
					return;
				}
			}
		}
#endif
#ifdef mtf_coop_rogue
		if ((world.model == "maps/r1m7.bsp"))
		{
			WriteByte (MSG_ALL, SVC_FINALE);
			WriteString (MSG_ALL, "Victory! The Overlord's mangled\nremains are the evidence.  His evil\nWrath army?  Cast out to wander\naimlessly throughout time.\n\nAs the Slipgate fog surrounds you,\nthoughts rage into your consciousness:\nHas Quake's oppressive reign ended?\nIs it S...");
			return;
		}
#endif
#ifdef mtf_coop_bbelief
		if ( world.model == "maps/bbelief7.bsp" || mapname == "bbelief7" )
		{
			WriteByte (MSG_ALL, SVC_CDTRACK);
			WriteByte (MSG_ALL, 3);
			WriteByte (MSG_ALL, SVC_FINALE);
			WriteString (MSG_ALL, "Once again you watch Chthon crumbling\nbefore your eyes. Why does it always\nhave to turn out that the bad guys\nweren't destroyed at the first attempt?\nBut now you're sure that Chthon will\nnever rise from his pool of lava again -\nthis time it wasn...");
			return;
		}
#endif
		GotoNextMap();
	}
	if (intermission_running == 3)
	{
		if (!cvar("registered"))
		{
			WriteByte(2, 33);
			return;
		}
		if ((serverflags & 15) == 15)
		{
			WriteByte(2, 31);
			WriteString(2, "Now, you have all four Runes. You sense\ntremendous invisible forces moving to\nunseal ancient barriers. Shub-Niggurath\nhad hoped to use the Runes Herself to\nclear off the Earth, but now instead,\nyou will use them to enter her home and\nconfront her as an avatar of avenging\nEarth-life. If you defeat her, you will\nbe remembered forever as the savior of\nthe planet. If she conquers, it will be\nas if you had never been born.");
			return;
		}
	}
	dprint("Exit Intermission.\n");
	GotoNextMap();
};
void() IntermissionThink = 
{
	if (time < intermission_exittime)
	{
		return;
	}
	if (!(self.button0) && !(self.button1) && !(self.button2))
	{
		return;
	}
	dprint("Intermission think.\n");
#ifdef mtf_coop
	ExitIntermission ();
#else
	GotoNextMap();
#endif
};
#ifdef mtf_coop_expsys
void (entity plyr, string nname, float exp) MTF_Coop_PreWriteExperience;
void () MTF_Coop_UpdateMapRanks;
#endif
#ifdef HALFLIFE
void () relandmark_touch =
{
	local entity targ, oself;
	if (!landmarked) {
		oself = self;
		targ = find( world, targetname, infokey (world, "landmark") );
		if (targ) {
			self = targ;
			info_landmark();
			self = oself;
			self.touch = changelevel_touch;
		}
		else {
			bprint(2,"WE BE SCREWED.\n");
			self.touch = changelevel_touch;
		}
	}
};
#endif
void() changelevel_use =
{
#ifdef mtf_coop
	if (num_players > 1 && can_exit == #FALSE) {
		if (votestarted == #VOTE_EXIT)
			return;
		if (total_monsters > killed_monsters)
		{
			if (votestarted > 0)
				return;
			else {
				self = activator;
				Vote_StartVote( #VOTE_EXIT, "", world );
				return;
			}
		}
	}

#endif
	other = activator; 
#ifndef COOP_HAX
	if (other.classname != "player")
		return;
#endif
	if (cvar("samelevel") == 2 || (cvar("samelevel") == 3 && mapname != "start")) {
		T_Damage (other, self, self, 50000);
		return;
	}
	bprint (#PRINT_HIGH, other.netname);
	if ( self.message ) {
		bprint( #PRINT_HIGH, self.message );
		bprint( #PRINT_HIGH, "\n" );
	} else
		bprint (#PRINT_HIGH, " exited the level.\n");

#ifdef mtf_coop_expsys
	MTF_DoEndBonus ( other );
#endif
	nextmap = self.map;
	SUB_UseTargets ();
	if ( (self.spawnflags & 1) && (deathmatch == 0) )
	{	// NO_INTERMISSION
		GotoNextMap();
		return;
	}
	self.touch = SUB_Null;
	self.think = execute_changelevel;
	self.nextthink = time + 0.1;
};
#ifdef SVEN_COOP
void () trigger_changelevel_parse;
void () trigger_changelevel_activate =
{
	self.touch = changelevel_touch;
	self.use = changelevel_use;
	self.solid = SOLID_TRIGGER;
};
void () exit_skins =
{
	if (self.frame == 0)
		self.frame = 1;
	else
		self.frame = 0;
	self.nextthink = time + 1;
};
#endif
void() trigger_changelevel = 
{
	if (CheckExistence() == 0)
	{
		dremove(self);
		return;
	}
#ifdef mtf_coop_rogue
	if (mapname == "r2m1")
		self.map = "r2m2";
#endif
	if (!(self.map))
	{
#ifdef SVEN_COOP
		if (!#HL_MAP)			// we store next map in the cvar string "nextmap"
#endif
		objerror("changelevel trigger doesn't have map");
	}
#ifdef mtf_coop_hipnotic

	if (self.map == "hip1m4")
		self.map = "hip2m1";
#endif
#ifdef mtf_coop
	if (mapname == "qte1m5")
		self.map = "qtstart";
	if (mapname == "qte2m4")
		self.map = "qtstart";
#endif
	InitTrigger();
#ifdef SVEN_COOP
	if (#HL_MAP) {
		precache_model ( "progs/hlexit.spr" );
		self.think = trigger_changelevel_parse;
#ifdef COOP_HAX
		self.nextthink = time + 4;
#else
		self.nextthink = time + .1;
#endif
		return;
	}
#endif
	self.touch = changelevel_touch;
	if ( self.targetname )
		self.use = changelevel_use;
};
#ifdef SVEN_COOP
void () trigger_changelevel_parse =
{
	local string nmt;
	nmt = cvar_string( "nomaptrans" );
	if ( nmt != "" ) {
		if ( self.map == nmt ) {
			self.touch = SUB_Null;
			self.use = SUB_Null;
			self.solid = SOLID_BBOX;
			self.renderamt = 0;
			HalfLife_DoRender();
			return;
		}
	}
	if ( cvar_string( "nextmap" ) != "" ) {
		if (!self.map) {
			self.use = self.use = changelevel_use;//trigger_changelevel_activate;
			self.map = cvar_string( "nextmap" );
			return;
		}
		newmis = spawn();
		setmodel( newmis, "progs/hlexit.spr" );
		newmis.solid = SOLID_TRIGGER;
		newmis.movetype = MOVETYPE_NONE;
		setsize(newmis, VEC_HULL_MIN, '16 16 40');
		setorigin( newmis, ((self.mins+self.maxs)*.5) );
		newmis.frame = 0;
		newmis.think = exit_skins;
		newmis.nextthink = time + 1;
		self.map = cvar_string( "nextmap" );
		trigger_changelevel_activate();
		return;
	}
	else {
		if (!self.map)
			objerror ("changelevel trigger doesn't have map.");
		if ( self.targetname )
			self.use = changelevel_use;
	}
	if (self.landmark) {
		if (self.targetname == "changetoc1a1e") {
			dremove(self);
			return;
		}
		if (hlt_think(self) == #TRUE) {
			dremove(self);
			return;
		}
	}
	if (!(self.spawnflags & 2))	// spawnflags 2 is use-only (which means we look for a trigger_transition generally..)
	self.touch = changelevel_touch;
	if ( self.targetname )
		self.use = changelevel_use;
};
#endif
void() respawn = 
{
	if (coop)
	{
		CopyToBodyQue(self);
		setspawnparms(self);
		self.pk_turretammo = 6;
		self.pk_beartrapammo = 12;
		self.pk_gravitywellammo = 2;
		self.pk_canpabammo = 2;
		PutClientInServer();
	}
	else
	{
		if (deathmatch)
		{
			CopyToBodyQue(self);
			SetNewParms();
			self.pk_turretammo = 6;
			self.pk_beartrapammo = 12;
			self.pk_gravitywellammo = 2;
			self.pk_canpabammo = 4;
			PutClientInServer();
		}
		else
		{
			localcmd("restart\n");
		}
	}
};
void() ClientKill = 
{
	local entity te;
	if (self.playerclass == 0)
	{
		return;
	}
#ifndef NO_SUICIDE_WAIT
	if (self.suicide_time > time)
	{
		if (self.suicideoverride < time) {
			sprint(self, 2, "30 sec delay to stop cheating!\n");
			return;
		}
	}
#endif
	if (self.bugger > 0)
	{
		sprint (self, 2, "Can't suicide while in camera!\n");
		return;
	}
	if (self.deadflag)
	{
		return;
	}
	if (self.tfstate & 16)
	{
		sprint(self, 2, "You wish life was that easy!\n");
		return;
	}
	if (self.hook_out)
	{
		sprint(self, 2, "You must retract hook first!\n");
		return;
	}
	self.suicide_time = time + 25 + random() * 5;
	bprint(TF_FLARE_OFF, self.netname);
	bprint(TF_FLARE_OFF, " suicides  :)\n");
#ifdef mtf_coop_lms
	if (lms_entity != world) {
		if (self.classname == "player")
			self.#lms_lives = self.#lms_lives - 1;
	}
#endif
	teamchangetimer(self);
	set_suicide_frame();
#ifdef PL_FEM
	self.modelindex = GetPlayerModelindex(self);
#else
	self.modelindex = modelindex_player;
#endif
	if (self.tfstate & 16)
	{
		te = find(world, classname, "timer");
		while (te)
		{
			if (te.owner == self && te.think == BioInfection_Decay)
			{
				logfrag(te, self);
				te.enemy.real_frags = te.enemy.real_frags + TF_FLARE_OFF;
				if (!(toggleflags & 128))
				{
					te.enemy.frags = te.enemy.real_frags;
				}
			}
			te = find(te, classname, "timer");
		}
	}
	else
	{
		logfrag(self, self);
	}
	self.real_frags = self.real_frags - TF_FLARE_OFF;
	if (!(toggleflags & 128))
	{
		self.frags = self.real_frags;
	}
	TeamFortress_RemoveTimers();
	TeamFortress_SetupRespawn(TF_FLARE_OFF);
	if (self.health < self.max_health)//Which means they were in combat..damaged or was in combat
		{
		sprint(self, 2, self.netname);
		sprint(self, 2, " was alive. For being a wuss for suiciding in combat, subtracting 6 points from him.\n");
		self.real_frags = self.real_frags - (TF_FLARE_OFF * 5 );
		}
	self.health = self.health - (self.health + TF_FLARE_OFF);
	self.th_die();
	self.deadflag = 3;
	self.tfstate = self.tfstate | 8192;
#ifdef mtf_coop
	if (survival_mode)
		if (Survival_Fail() == #TRUE)
			return;
#endif
};
void(entity e) ValidateUser = 
{};
void() PutClientInServer = 
{
// refers to entity playerfob;  //This is what follows the player and is colored to their team.
	self.pk_turretammo = 6;  //set painkeep weapon ammo amounts. -arg
	self.pk_beartrapammo = 12;
	self.pk_gravitywellammo = 4;
	self.pk_canpabammo = 2;
	self.vote_wait = time; // This allows new connected users to start a vote after 1 second from joining. -arg
	local float tc;
	local string st;
	local float iszoom;
	local float oldclass;
	local entity spot;
	local entity te;
	self.touch = player_touch;
	self.classname = "player";
	self.health = 100;
	self.takedamage = 2;
	self.solid = 3;
	self.movetype = 3;
	self.show_hostile = 0;
	self.FlashTime = 0;
#ifdef mtf_coop_expsys
	self.max_health = floor( self.max_health * MTF_Coop_AttribGain(self, #ATTRIB_HEALTH) );
#else
	self.max_health = 100;
#endif
	self.flags = 8;
#ifdef mtf_coop
self.flags = self.flags - (self.flags & #FL_FINDABLE_NONSOLID);
#ifdef HALFLIFE
	self.oldgravity = 1;
#endif
#endif
	self.air_finished = time + 12;
	self.dmg = 2;
	self.super_damage_finished = 0;
	self.radsuit_finished = 0;
	self.invisible_finished = 0;
	self.invincible_finished = 0;
#ifdef mtf_coop_expsys
	self.speed_finished = 0;
	self.speed_time = 0;
	self.effects = self.effects - (self.effects & EF_RED);
#endif
#ifdef mtf_coop
	MTF_Coop_ResetItems();
	self.#rune_finished = 0;
	self.#rune_time = 0;
	self.reload_rail_gun = 0;
#endif
	self.effects = 0;
	self.invincible_time = 0;
	self.reload_shotgun = 0;
	self.reload_super_shotgun = 0;
	self.reload_grenade_launcher = 0;
	self.reload_rocket_launcher = 0;
	self.immune_to_check = time + 5;
	self.on_hook = 0;
	self.active_grenades_1 = 0;
	self.active_grenades_2 = 0;
	self.nextuse_para = time;
	self.hook_out = 0;
	self.fire_held_down = 0;
	stuffcmd(self, "play misc/null.wav\n");
	DecodeLevelParms();
#ifndef mtf_coop
	stuffcmd (self, "alias voteyes impulse 245\n");  //removed auto aim/speed det stuff to impulse 240 -arg
	stuffcmd (self, "cl_sidespeed 500\ncl_backspeed 500\ncl_forwardspeed 500\n");
#endif
	self.client = "unknown";
	st = infokey (self, "*client");
	if ((st == "mqwcl 0.96"))
	{
		self.client = "moreqw";
		self.clientv = "0.96";
	}
	else
	{
		if ((st == "mqwcl 0.95"))
		{
			self.client = "moreqw";
			self.clientv = "0.95";
		}
		else
		{
			if ((st == "mqwcl 0.93"))
			{
				self.client = "moreqw";
				self.clientv = "0.93";
			}
		}
	}
	st = infokey (self, "*ip");
	if ((st != ""))
	{
// There shouldn't be no auto aiming at all ffs -arg
//		st = infokey (self, "*ver");
//		if ((st == "2.40-0858"))
//		{
//			stuffcmd (self, "aa_enabled");
//			stuffcmd (self, "\n");
//		}
	}
	st = infokey (self, "*z_ver");
	if ((st != ""))
	{
		self.client = "zquake";
		self.clientv = st;
	}
	st = infokey (self, "*FuhQuake");
	if ((st != ""))
	{
		self.client = "fuhquake";
		self.clientv = st;
	}
	if (self.client == "unknown")
	{
		st = infokey (self, "*ver");
		if ((st != ""))
		{
			self.client = st;
		}
		st = infokey (self, "*client");
		if ((st != ""))
		{
			self.client = st;
		}
	}
	st = infokey (self, "tf_stats");
	if (((st == "on") || (st == "1")))
	{
		if (((self.client != "fuhquake") && (self.client != "zquake")))
		{
			sprint (self, 2.000000, "Weapon statistics require fuhquake/zquake (www.fuhquake.net)\n");
			self.stats_on = 0.000000;
			stuffcmd (self, "setinfo tf_stats off\n");
		}
		else
		{
			self.stats_on = 1.000000;
		}
	}
	else
	{
		self.stats_on = 0.000000;
	}
	if (clr_enabled)
	{
		if (!IsLegalClient (self))
		{
			stuffcmd (self, "disconnect\necho\necho illegal client, restrictions in effect\necho\n");
			bprint (1.000000, self.netname);
			bprint (1.000000, " tried to join using an illegal client.\n");
			return;
		}
	}
	if (self.playerclass == 0)
	{
		if (TeamFortress_TeamIsCivilian(self.team_no))
		{
			self.impulse = TF_FLARE_OFF;
			TeamFortress_SetSpeed(self);
			TeamFortress_ChangeClass();
		}
	}
#ifdef mtf_coop
	if (self.nextpc != 0)
#else
	if (deathmatch == 3 && self.nextpc != 0)
#endif
	{
		tc = IsRestrictedClass(self.nextpc);
		if ( tc == 0)
		{
			self.playerclass = self.nextpc;
			if (self.nextpc == 10)
			{
				self.tfstate = self.tfstate | 8;
			}
			else
			{
				self.tfstate = self.tfstate - (self.tfstate & 8);
			}
		}
		else
		{
			if (tc > 0)
			{
				sprint(self, 2, "That class is restricted to ");
				st = ftos(tc);
				sprint(self, 2, st);
				sprint(self, 2, " per team.\n");
			}
			else
			{
				sprint(self, 2, "That class is disabled.\n");
			}
			self.nextpc = 0;
		}
	}
	iszoom = 0;
	if (self.tfstate & 4096)
	{
		iszoom = TF_FLARE_OFF;
	}
	if (self.tfstate & 8)
	{
		oldclass = TF_FLARE_OFF + floor(random() * (10 - TF_FLARE_OFF));
		while (!IsLegalClass(oldclass) || (IsRestrictedClass(oldclass) != 0) ) // pablo. removed this cause of problems if all but 1 class restricted. || (self.playerclass == oldclass) )
		{
			oldclass = TF_FLARE_OFF + floor(random() * (10 - TF_FLARE_OFF));
		}
		self.playerclass = oldclass;
		self.tfstate = 8;
	}
	else
	{
		self.tfstate = 0;
	}
	if (iszoom == TF_FLARE_OFF)
	{
		self.tfstate = self.tfstate | 4096;
	}
	if ((self.playerclass != 8.000000))
	{
		te = find (world, classname, "camera");
		while (te)
		{
			if ((te.owner == self))
			{
				camera_die (te);
			}
			te = find (te, classname, "camera");
		}
	}
	if ((self.playerclass != 4))
	{
		te = find (world, classname, "trip_bomb");
		while (te)
		{
			if ((te.real_owner == self))
			{
				TF_T_Damage (te, world, world, 500, 0, 0);
			}
			te = find (te, classname, "trip_bomb");
		}
	}
	if ((self.playerclass != 5))
	{
		te = find (world, classname, "drop4");
		while (te)
		{
			if ((te.real_owner == self))
			{
				kill_medpack(te);
			}
			te = find (te, classname, "trip_bomb");
		}
	}
	if (self.playerclass != 9)
	{
		te = find(world, classname, "building_dispenser");
		while (te)
		{
			if (te.real_owner == self)
			{
				TF_T_Damage(te, world, world, 500, 0, 0);
			}
			te = find(te, classname, "building_dispenser");
		}
		te = find(world, classname, "building_sentrygun");
		while (te)
		{
			if (te.real_owner == self)
			{
				TF_T_Damage(te, world, world, 500, 0, 0);
			}
			te = find(te, classname, "building_sentrygun");
		}
		te = find (world, classname, "building_tesla");
		while (te)
		{
			if ((te.real_owner == self))
			{
				TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
			}
			te = find (te, classname, "building_tesla");
		}
		te = find (world, classname, "building_fieldgen");
		while (te)
		{
			if ((te.real_owner == self))
			{
				TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
			}
			te = find (te, classname, "building_fieldgen");
		}
		te = find (world, classname, "building_camera");
		while (te)
		{
			if ((te.real_owner == self))
			{
				TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
			}
			te = find (te, classname, "building_camera");
		}
		te = find (world, classname, "building_teleporter");
		while (te)
		{
			if ((te.real_owner == self))
			{
				TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
			}
			te = find (te, classname, "building_teleporter");
		}
	}
	self.tools = (self.tools - (self.tools & 32));	// Remove submarine
#ifdef botprogs
	self.curr_wp = 0;
#endif
	TeamFortress_PrintClassName (self, self.playerclass, (self.tfstate & 8.000000), 0);
	TeamFortress_SetEquipment ();
	TeamFortress_SetHealth ();
	TeamFortress_SetSpeed (self);
	TeamFortress_SetSkin (self);
#ifndef mtf_coop
#endif
	SetTeamName (self);
	W_SetCurrentAmmo ();
	self.attack_finished = (time + 0.300000);
	self.th_pain = player_pain;
	self.th_die = PlayerDie;
	if ((self.height != 0.000000))
	{
		self.height = 0.000000;
		TF_zoom (90.000000);
	}
	self.deadflag = 0.000000;
	self.pausetime = 0.000000;
	spot = SelectSpawnPoint ();
#ifdef SVEN_COOP
	if (#HL_MAP)
		if (spot == world)	// hack :(
			spot = SelectSpawnPoint ();
#endif
	if ((self.playerclass != 0.000000))
	{
		spawn_tdeath (spot.origin, self);
	}
	self.observer_list = spot;
	self.origin = (spot.origin + '0.000000 0.000000 1.000000');
#ifdef mtf_coop
	if (self.monster_type > 0)
		if (spot.is_monster == 1)
			Killed(spot, world);
#endif
	self.angles = spot.angles;
	self.fixangle = 1.000000;
	if ((spot.classname == "info_player_teamspawn"))
	{
		if ((spot.items != 0.000000))
		{
			te = Finditem (spot.items);
			if (te)
			{
				tfgoalitem_GiveToPlayer (te, self, self);
			}
			if (!(spot.goal_activation & 1.000000))
			{
				spot.items = 0.000000;
			}
		}
		if (prematch)
		{
		}
		else
		{
			if (spot.message)
			{
				CenterPrint (self, spot.message);
				if (!(spot.goal_activation & 2.000000))
				{
					spot.message = string_null;
				}
			}
		}
		if ((spot.activate_goal_no != 0.000000))
		{
			te = Findgoal (spot.activate_goal_no);
			if (te)
			{
				AttemptToActivate (te, self, spot);
			}
		}
		if ((spot.goal_effects == 1.000000))
		{
			spot.classname = "deadpoint";
			spot.team_str_home = string_null;
			spot.nextthink = (time + 1.000000);
			spot.think = SUB_Remove;
		}
	}
	setmodel (self, string_null);
	modelindex_null = self.modelindex;
	setmodel (self, "progs/eyes.mdl");
	modelindex_eyes = self.modelindex;
#ifdef APRIL_FOOLS
	setmodel (self, "progs/a1player.mdl");
#else
#ifdef PL_FEM
	setmodel (self, GetPlayerModel(self));
#else
	setmodel (self, "progs/player.mdl");
#endif
#endif
#ifdef mtf_coop
	if (self.monster_type == 0)
#endif
#ifdef PL_FEM
	SetPlayerModelindex(self);
#else
	modelindex_player = self.modelindex;
#endif
	modelindex_plyr = self.modelindex; // BTF
	if ((self.playerclass == 0.000000))
	{
		self.modelindex = modelindex_null;
		self.current_menu = 1.000000;
		TeamFortress_Alias ("id", 185.000000, 0.000000);
		bprint (1.000000, self.netname);
		bprint (1.000000, " is using ");
		if ((self.client != "unknown"))
		{
			bprint (1.000000, self.client);
			bprint (1.000000, " ");
			bprint (1.000000, self.clientv);
		}
		else
		{
			bprint (1.000000, "an unknown client. Check for shady activity.");
		}
		bprint (1.000000, "\n");
		if (self.stats_on)
		{
#ifndef mtf_coop
			stuffcmd (self, "set stats_execed 0\nexec progs/stats.cfg\n");
#endif
		}
	}
	setsize (self, '-16.000000 -16.000000 -24.000000', '16.000000 16.000000 32.000000');
	self.view_ofs = '0.000000 0.000000 22.000000';
//create fob for player and spawn it. attach think to player stand() -arg
//start the colored playerfob and assign it to player_stand1 for think to update it as
// the players team color changes. Each time they spawn or put in server they get the fob in this loop.
	attachplayerfob(); //new function.
	player_stand1 ();
	if ((deathmatch || coop))
	{
		makevectors (self.angles);
		if ((self.playerclass != 0.000000))
		{
			spawn_tfog ((self.origin + (v_forward * 20.000000)));
		}
	}
	if ((stof (infokey (world, "rj")) != 0.000000))
	{
		rj = stof (infokey (world, "rj"));
	}
	else
	{
		rj = 2.000000;
	}
	if ((self.noise == "player/mdeath5.wav"))
	{
		sound (self, 2.000000, "player/malive5.wav", 1.000000, 1.000000);
	}
	self.killstack = 0;
};
void() info_player_start = 
{
#ifndef mtf_coop
	if (CheckExistence() == 0)
	{
		dremove(self);
		return;
	}
#endif
#ifdef mtf_coop_nehahra
	if ((world.model == "maps/nehend.bsp") || mapname == "nehend")
	{
		if (deathmatch)
		{
			return;
		}
		precache_mr ();
		spawn_mister ();
	}
#endif
#ifdef SVEN_COOP
	if (#HL_MAP)
		self.classname = "info_intermission";
#endif
};
void() info_player_start2 = 
{
#ifndef mtf_coop
	if (CheckExistence() == 0)
	{
		dremove(self);
		return;
	}
#endif
};
#ifdef SVEN_COOP
void () info_player_deathmatch_use =
{
	if (self.has_tesla == 1) {
		self.has_tesla = 0;
		self.classname = "info_player_coop";
	}
	else {
		self.has_tesla = 1;
		self.classname = "info_poop";
	}
};
#endif
void() testplayerstart = 
{
	if (CheckExistence() == 0)
	{
		dremove(self);
		return;
	}
};
void() info_player_deathmatch = 
{
#ifdef mtf_coop
#ifdef SVEN_COOP
	if (#HL_MAP) {
		if (self.spawnflags & 2) {	// start disabled
			self.has_tesla = 1;
			self.classname = "info_poop";
		}
		else
			self.classname = "info_player_coop";
		self.use = info_player_deathmatch_use;
	}
	else
#endif
	dremove(self);
#endif
	if (CheckExistence() == 0)
	{
		dremove(self);
		return;
	}
};
void() info_player_coop = 
{
#ifdef mtf_coop
	if (self.targetname) {
		dremove(self);
		return;
	}
#endif
	if (CheckExistence() == 0)
	{
		dremove(self);
		return;
	}
};
void(entity c) PrintClientScore = 
{
	if (c.frags > -10 && c.frags < 0)
	{
		bprint(TF_FLARE_OFF, " ");
	}
	else
	{
		if (c.frags >= 0)
		{
			if (c.frags < 100)
			{
				bprint(TF_FLARE_OFF, " ");
			}
			if (c.frags < 10)
			{
				bprint(TF_FLARE_OFF, " ");
			}
		}
	}
	bprint(TF_FLARE_OFF, ftos(c.frags));
	bprint(TF_FLARE_OFF, " ");
	bprint(TF_FLARE_OFF, c.netname);
	bprint(TF_FLARE_OFF, "\n");
};
void() DumpScore = 
{
	local entity e;
	local entity sort;
	local entity walk;
	if (world.chain)
	{
		error("DumpScore: world.chain is set");
	}
	e = find(world, classname, "player");
	sort = world;
	while (e)
	{
		if (!sort)
		{
			sort = e;
			e.chain = world;
		}
		else
		{
			if (e.frags > sort.frags)
			{
				e.chain = sort;
				sort = e;
			}
			else
			{
				walk = sort;
				do
				{
					if (!(walk.chain))
					{
						e.chain = world;
						walk.chain = e;
					}
					else
					{
						if (walk.chain.frags < e.frags)
						{
							e.chain = walk.chain;
							walk.chain = e;
						}
						else
						{
							walk = walk.chain;
						}
					}
				} while (walk.chain != e);
			}
		}
		e = find(e, classname, "player");
	}
	bprint(TF_FLARE_OFF, "\n");
	while (sort)
	{
		PrintClientScore(sort);
		sort = sort.chain;
	}
	bprint(TF_FLARE_OFF, "\n");
};
void() NextLevel = 
{
	local entity o;
	if (already_cycled)
	{
		return;
	}
	already_cycled = TF_FLARE_OFF;
	o = spawn();
	o.map = nextmap;
	o.think = execute_changelevel;
	o.nextthink = time + 0.1;
};
void() CheckRules = 
{
#ifndef mtf_coop
	if (timelimit && time >= timelimit)
	{
		NextLevel();
	}
	else
	{
		if (fraglimit && self.frags >= fraglimit)
		{
			NextLevel();
		}
	}
#endif
};
#ifdef mtf_coop
void () pdummy_wait_on_reconnect =
{
	local entity te;
	local float isgud;
	te = find(world, classname, "player");
	while (te) {
		if (te.connect_name == self.netname) {
			isgud = 1;
			self.real_owner = te;
			break;
		}
		te = find(te, classname, "player");	
	}
	if (isgud)
		self.has_tesla = 1;
	else
		self.has_tesla = 0;
	if (self.enemy == world || self.real_owner.team_no != 0) {
		strunzone(self.netname);
		dremove(self);
		dremove(self.enemy);
		return;
	}
	self.nextthink = time + .5;
};

void () pdummy_spawn_think =
{
	local entity pdummy, oself;
	oself = self;
	pdummy = spawn();
	if (self.monster_type == 1)
		setmodel(pdummy, "progs/player.mdl");
	pdummy.movetype = 0;
	pdummy.solid = 0;
	pdummy.classname = "resdummy";
	pdummy.think = pdummy_think;
	pdummy.nextthink = time + 1;
	pdummy.team_no = self.team_no;  //Assign a team number to the dead survivor player just in case.
//That way only team members of the same team can only ressurrect you, not just any player. -arg
//Also if someone uses a cube, it can only res those on the same team.
	if (self.monster_type == 1)
	{
		setsize(pdummy, self.mins, self.maxs);
		setorigin(pdummy, self.origin);
		setmodel(pdummy, "progs/player.mdl");
		pdummy.frame = 49;
		pdummy.monster_type = 1;
		pdummy.owner = self;
		pdummy.real_owner = self;
		self.health = 1;
		self.solid = SOLID_TRIGGER;
		self.enemy = pdummy;
		self.think = pdummy_wait_on_reconnect;
		self.nextthink = time + .5;
		pdummy.team_no = 2;  // Hey, I am a dead monster, I belong on team 2 only. -arg
//I will put in a check to make sure only players on team 2 are resurrected, not monsters -arg
		return;
	}
	sprint( self.owner, 2, "Call a Player to resurrect you using \"saveme\". DO NOT RECONNECT!\n" );
	pdummy.team_no = self.team_no;  //Assign a team number to the dead survivor player just in case.
//That way only team members of the same team can only ressurrect you, not just any player. -arg

	pdummy.enemy = self.owner;
	pdummy.owner = self.owner;		// used for saveme
	setsize(pdummy, pdummy.owner.mins, pdummy.owner.maxs);
	pdummy.skin = self.owner.skin;
	pdummy.frame = self.owner.frame;
	pdummy.colormap = self.owner.colormap;
	if (!self.owner.model)
#ifdef APRIL_FOOLS
		setmodel(pdummy, "progs/a1player.mdl");
#else
		setmodel(pdummy, "progs/player.mdl");
#endif		
	else
		setmodel(pdummy, self.owner.model);
	setorigin(pdummy, self.owner.origin);
	pdummy.velocity = pdummy.owner.velocity;
	pdummy.frame = self.owner.frame;
	pdummy.angles = self.owner.angles;
	self = self.owner;
	self.classname = "observer";
	self.tfstate = self.tfstate - (self.tfstate & 8);
	self.movetype = 8;
	self.solid = 0;
	self.model = "";
	self.mdl = "";
	self.velocity = '0 0 0';
	self.avelocity = '0 0 0';
	self.enemy = world;
	self.monster_items = 1;
	self.lives = -1;
	setmodel(self, "");
	self.view_ofs = '0 0 1';
	self.angles = '0 0 0';
	self.health = 1;
	self = pdummy;
	pdummy.think();
	self = oself;
	dremove(self);
};
#endif
void () PlayerDeathThink =
{
	local float _l_5972;
#ifdef mtf_coop
	local entity te;
	local float foundme;
	if (survival_mode)
	{
			if (self.monster_type != 0)
			{
				if ((self.respawn_time <= time))
				{
					self.button0 = 0.000000;
					self.button1 = 0.000000;
					self.button2 = 0.000000;
					respawn ();
				}
			}
			if (self.button0)
			{
				if (self.atomic_intensity < time)
				{
					self.atomic_intensity = time + 0.5;
			
					te = find(world, classname, "resdummy");
					while (te)
					{
						if (te.owner == self)
						{
							WriteByte(4, 23);
							WriteByte(4, 11);
							WriteCoord(4, te.origin_x);
							WriteCoord(4, te.origin_y);
							WriteCoord(4, te.origin_z);
							if ((self.last_saveme_sound < time))
							{
								sound (te, TF_FLARE_OFF, "speech/saveme1.wav", TF_FLARE_OFF, TF_FLARE_OFF);
								self.last_saveme_sound = (time + 4);
							}
							foundme = TRUE;
						}
						te = find(te, classname, "resdummy");
					}
					if (!foundme && (self.view_ofs != '0 0 -8') ) {
						bprint(2,"PlayerDeathThink: PDUMMY Not Found - Take a screenshot of your console and send it to DEV\n");
						self.ammo_cells = 666;				// so we spawn at the beginning
						MTF_Resurrect_Player ( self );
					}
					else if (!foundme)
					{
						if (self.velocity_x < 1 && self.velocity_x > -1 &&
						self.velocity_y < 1 && self.velocity_y > -1 &&
						self.velocity_z < 1 && self.velocity_z > -1)
						{
							bprint(2,"Somebody is impatient.. You can beg for the answer...\n");
							Survival_MakeDummy( 0 );
							self.ammo_cells = 666;				// so we spawn at the beginning
//							MTF_Resurrect_Player ( self );
// make em wait for a res cube or cmd beg for it. -arg 
						}
					}
					else
					{
						sprint( self, 2, "Call a player to resurrect you using \"saveme\". DO NOT RECONNECT!\n" );
					return;
					}
					}
	}
#endif
	if ((self.flags & 512.000000))
	{
		_l_5972 = vlen (self.velocity);
		_l_5972 = _l_5972 - 20.000000;
		if ((_l_5972 <= 0.000000))
		{
			self.velocity = '0.000000 0.000000 0.000000';
		}
		else
		{
			self.velocity = (_l_5972 * normalize (self.velocity));
		}
	}
	if ((self.deadflag == 2.000000))
	{
		if (((self.button2 || self.button1) || self.button0))
		{
			return;
		}
		self.deadflag = 3.000000;
		self.tfstate = (self.tfstate - (self.tfstate & 8192.000000));
		return;
	}
	if (((!self.button2 && !self.button1) && !self.button0))
	{
		if ((self.tfstate & 8192.000000))
		{
			if ((self.respawn_time <= time) && !(survival_mode))
			{
				self.button0 = 0.000000;
				self.button1 = 0.000000;
				self.button2 = 0.000000;
				respawn ();
			}
		}
		return;
	}
	}
	else
	{
	
		self.tfstate = (self.tfstate | 8192.000000);
		if ((self.respawn_time <= time))
		{
			self.button0 = 0.000000;
			self.button1 = 0.000000;
			self.button2 = 0.000000;
			respawn ();
		}
		return;
	}
};
void () PlayerJump =
{
	if (self.Aircraft_Owner)
	{
		return;
	}
	if ((self.nojumptime > time))
	{
		if ((self.velocity_x > 70.000000))
		{
			self.velocity_x = 70.000000;
		}
		else
		{
			if ((self.velocity_x < -70.000000))
			{
				self.velocity_x = -70.000000;
			}
		}
		if ((self.velocity_y > 70.000000))
		{
			self.velocity_y = 70.000000;
		}
		else
		{
			if ((self.velocity_y < -70.000000))
			{
				self.velocity_y = -70.000000;
			}
		}
	}
	if ((self.flags & 2048.000000))
	{
		return;
	}
#ifdef HALFLIFE
	local float lad;
	if (self.laddertime > time && self.ladderjump < time) {
		if (!(self.flags & FL_ONGROUND)) self.flags = self.flags + FL_ONGROUND;
		self.ladderjump = time+0.4;
		self.velocity_z = 0;
		makevectors(self.angles);
		self.velocity = self.velocity + (v_forward*100);
		lad = 80;
	}
#endif
	if ((self.waterlevel >= 2.000000))
	{
		if ((self.watertype == -3.000000))
		{
			self.velocity_z = 100.000000;
		}
		else
		{
			if ((self.watertype == -4.000000))
			{
				self.velocity_z = 80.000000;
			}
			else
			{
				self.velocity_z = 50.000000;
			}
		}
		if ((self.swim_flag < time))
		{
			self.swim_flag = (time + 1.000000);
			if ((self.tools == (self.tools | 32)))
			{
				return;
			}
			if ((random () < 0.500000))
			{
				sound (self, 4.000000, "misc/water1.wav", 1.000000, 1.000000);
			}
			else
			{
				sound (self, 4.000000, "misc/water2.wav", 1.000000, 1.000000);
			}
		}
		return;
	}
	if (!(self.flags & 512.000000))
	{
		return;
	}
	if (!(self.flags & 4096.000000))
	{
		return;
	}
	self.flags = (self.flags - (self.flags & 4096.000000));
	self.button2 = 0.000000;
	if ((self.playerclass == 8.000000))
	{
		if ((self.spy_regjump == 0.000000))
		{
			sound (self, 4.000000, "hknight/slash1.wav", 0.700000, 1.000000);
			self.velocity_z = (self.velocity_z + 400.000000);
			if (infokey(world, "prozacserver") == "1") { if( self.velocity_z < 0 ) self.velocity_z = 0; }
		}
		else
		{
			sound (self, 4.000000, "player/plyrjmp8.wav", 1.000000, 1.000000);
			self.velocity_z = (self.velocity_z + 270.000000);
			if (infokey(world, "prozacserver") == "1") { if( self.velocity_z < 0 ) self.velocity_z = 0; }
		}
	}
	else
	{
		sound (self, 4.000000, "player/plyrjmp8.wav", 1.000000, 1.000000);
		self.velocity_z = (self.velocity_z + 270.000000);
		if (infokey(world, "prozacserver") == "1") { if( self.velocity_z < 0 ) self.velocity_z = 0; }
	}
};
void() WaterMove = 
{
	if ((self.Aircraft_Owner && (self.watertype == -3)))
	{
		self.Aircraft_Owner = 0;
		self.health = -30;
		self.Aircraft_Speed = 0;
		self.gravity = 1;
		self.flash = 0;
		AC_Eject ();
	}
	if (self.movetype == 8)
	{
		return;
	}
	if (self.health < 0)
	{
		return;
	}
	if (self.waterlevel != 3)
	{
		if ((self.tools != (self.tools | 32)))
		{
			if ((self.air_finished < time))
			{
				sound (self, 2, "player/gasp2.wav", 1, 1);
			}
			else
			{
				if ((self.air_finished < (time + 9)))
				{
					sound (self, 2, "player/gasp1.wav", 1, 1);
				}
			}
			self.air_finished = (time + 12);
			self.dmg = 2;
		}
		else
		{
			self.air_finished = (time + 12);
		}
	}
	else
	{
		if (self.air_finished < time)
		{
			if ((self.pain_finished < time))
			{
				if ((self.tools == (self.tools | 32)))
				{
					self.pain_finished = (time + 12);
					return;
				}
				else
				{
					self.dmg = (self.dmg + 2);
				}
				if ((self.dmg > 15))
				{
					self.dmg = 10;
				}
				TF_T_Damage (self, world, world, self.dmg, 1, 0);
				self.pain_finished = (time + 1);
			}
		}
	}
	if (!(self.waterlevel))
	{
		if (self.flags & 16)
		{
			sound(self, 4, "misc/outwater.wav", TF_FLARE_OFF, TF_FLARE_OFF);
			self.flags = self.flags - 16;
		}
		if ((self.tools == (self.tools | 32)))
		{
			exit_vehicle ();
			TeamFortress_SetSpeed (self);
		}
		return;
	}
	if (self.watertype == -5)
	{
		if (self.dmgtime < time)
		{
			if (self.radsuit_finished > time)
			{
				self.dmgtime = time + TF_FLARE_OFF;
			}
			else
			{
				self.dmgtime = time + 0.2;
			}
			TF_T_Damage(self, world, world, 10 * self.waterlevel, 0, 16);
		}
	}
	else
	{
		if (self.watertype == -4)
		{
			if (self.dmgtime < time && self.radsuit_finished < time)
			{
				self.dmgtime = time + TF_FLARE_OFF;
				T_Damage(self, world, world, 4 * self.waterlevel);
			}
		}
	}
	if (!(self.flags & 16))
	{
		if (self.watertype == -5)
		{
			sound(self, 4, "player/inlava.wav", TF_FLARE_OFF, TF_FLARE_OFF);
		}
		if (self.watertype == -3)
		{
			sound(self, 4, "player/inh2o.wav", TF_FLARE_OFF, TF_FLARE_OFF);
		}
		if (self.watertype == -4)
		{
			sound(self, 4, "player/slimbrn2.wav", TF_FLARE_OFF, TF_FLARE_OFF);
		}
		self.flags = self.flags + 16;
		self.dmgtime = 0;
		self.chute_active = 0;
	}
};
void() CheckWaterJump = 
{
	local vector start;
	local vector end;
	makevectors(self.angles);
	start = self.origin;
	start_z = start_z + 8;
	v_forward_z = 0;
	normalize(v_forward);
	end = start + v_forward * 24;
	traceline(start, end, TF_FLARE_OFF, self);
	if (trace_fraction < TF_FLARE_OFF)
	{
		start_z = start_z + self.maxs_z - 8;
		end = start + v_forward * 24;
		self.movedir = trace_plane_normal * -50;
		traceline(start, end, TF_FLARE_OFF, self);
		if (trace_fraction == TF_FLARE_OFF)
		{
			self.flags = self.flags | 2048;
			self.velocity_z = 225;
			self.flags = self.flags - (self.flags & 4096);
			self.teleport_time = time + 2;
			return;
		}
	}
};
void () PlayerPreThink =
{
	local vector src;
#ifdef botprogs
	if (BotPreFrame ())
	{
		return;
	}
#endif
	if (self.autoid)
	{
		makevectors (self.v_angle);
		src = self.origin + (v_forward * 10.000000);
		src_z = self.absmin_z + (self.size_z * 0.700000);
		traceline (src, (src + (v_forward * 2048.000000)), 0.000000, self);
		if (((trace_ent != world) && (trace_ent.origin != world.origin)))
		{
			if ((self.current_menu == 19.000000))
			{
				return;
			}
			if ((self.current_menu == 16.000000))
			{
				return;
			}
			if ((self.current_menu != 17.000000))
			{
				TeamFortress_ID ();
				self.StatusRefreshTime = (time + 0.200000);
			}
		}
	}
	if ((self.is_feigning && (self.waterlevel == 1.000000)))
	{
		self.watertype = -3.000000;
		self.waterlevel = 3.000000;
	}
	if (intermission_running)
	{
		if ((intermission_running && (self.last_used != 999.000000)))
		{
			if ((random () < 0.500000))
			{
			}
			else
			{
			}
			self.last_used = 999.000000;
		}
		IntermissionThink ();
		return;
	}
	makevectors (self.v_angle);
	if ((self.playerclass == 0.000000))
	{
		self.maxspeed = 0.000000;
		self.gravity = 0.000000;
#ifdef mtf_coop
		if (!survival_mode)
#endif
		if (((self.button2 && (self.current_menu == 2.000000)) && (self.team_no == 0.000000)))
		{
			if (TeamFortress_TeamPutPlayerInTeam ())
			{
				self.current_menu = 3.000000;
				self.menu_count = 25.000000;
			}
		}
	}
	if ((self.view_ofs == '0.000000 0.000000 0.000000'))
	{
		return;
	}
	CheckRules ();
	if ((self.playerclass != 0.000000))
	{
		WaterMove ();
	}
	if ((self.deadflag >= 2.000000))
	{
		PlayerDeathThink ();
		return;
	}
	if (((self.undercover_team || self.undercover_skin) || self.is_undercover))
	{
		if ((self.effects & 12.000000))
		{
			sprint (self, 1.000000, "The glowing removes your disguise.\n");
			Spy_RemoveDisguise (self);
		}
	}
	if ((self.deadflag == 1.000000))
	{
		return;
	}
	if (!self.is_feigning)
	{
		if (self.button2)
		{
#ifdef PL_FEM
			if (self.current_menu == 3 && self.playerclass == 0)
				if (self.offgroundmessage < time) {
					if (self.gender == GENDER_MALE) {
						sprint(self,2, "Gender set to: Female.\n");
						self.gender = GENDER_FEMALE;
					}
					else if (self.gender == GENDER_FEMALE) {
						sprint(self,2, "Gender set to: Male.\n");
						self.gender = GENDER_MALE;
					}
					self.offgroundmessage = time + 0.5;
				}
#endif
			PlayerJump ();
		}
		else
		{
			self.flags = (self.flags | 4096.000000);
		}
	}
	else
	{
		if (self.waterlevel)
		{
			self.velocity_z = -100.000000;
		}
	}
	if ((time < self.pausetime))
	{
		self.velocity = '0.000000 0.000000 0.000000';
	}
	if ((((time > self.attack_finished) && (self.currentammo == 0.000000)) && (self.weapon > 16.000000)))
	{
		self.weapon = W_BestWeapon ();
		W_SetCurrentAmmo ();
	}
	if (self.on_hook)
	{
		Service_Grapple ();
	}
};
void() CheckPowerups = 
{
	local float lighton;
	local entity te;
	if (self.health <= 0)
	{
		return;
	}
	if (self.playerclass == 0)
	{
		self.modelindex = modelindex_null;
	}
	else
	{
		if (self.is_undercover == TF_FLARE_OFF && invis_only == TF_FLARE_OFF)
		{
			self.frame = 0;
			self.modelindex = modelindex_eyes;
		}
		else
		{
			if (self.invisible_finished)
			{
				if (self.tfstate & 64)
				{
					if (self.invisible_finished < time + 10)
					{
						self.invisible_finished = time + 666;
					}
				}
				if (self.invisible_sound < time)
				{
					sound(self, 0, "items/inv3.wav", 0.5, 2);
					self.invisible_sound = time + (random() * 3 + TF_FLARE_OFF);
				}
				if (self.invisible_finished < time + 3)
				{
					if (self.invisible_time == TF_FLARE_OFF)
					{
						sprint(self, 2, "Invisibility is fading.\n");
						stuffcmd(self, "bf\n");
						sound(self, 0, "items/inv2.wav", TF_FLARE_OFF, TF_FLARE_OFF);
						self.invisible_time = time + TF_FLARE_OFF;
						attachplayerfob();  // Reattach the colored playerfob to player
					}
					if (self.invisible_time < time)
					{
						self.invisible_time = time + TF_FLARE_OFF;
						stuffcmd(self, "bf\n");
					}
				}
				if (self.invisible_finished < time)
				{
					self.items = self.items - 524288;
					self.invisible_finished = 0;
					self.invisible_time = 0;
				}
				self.frame = 0;
				self.modelindex = modelindex_eyes;
#ifdef VWEPS
				VWEPS_SetModel ();
#endif
			}
			else
			{
#ifdef mtf_coop
				if (self.monster_type > 0)
					Monsterteam_setmodel(self, self.monster_type);
				else
#endif
#ifdef PL_FEM
				self.modelindex = GetPlayerModelindex(self);
#else
				self.modelindex = modelindex_player;
#endif
			}
		}
	}
	if ((self.tools == 32))		// Am I a submarine?
	{
		setmodel (self, "progs/mini-sub.mdl");
		modelindex_sub = self.modelindex;
	}
	if ((self.Aircraft_Owner == 1))
	{
#ifdef VWEPS
		self.vw_index = 31;
#endif
		setmodel (self, "progs/helo2.mdl");
		modelindex_aircraft = self.modelindex;
	}
	if (((self.bugger > 0.000000) && (self.playerclass == 8.000000)))
	{
		self.modelindex = modelindex_null;
	}
#ifdef VWEPS
#ifdef PL_FEM
	if (self.gender == GENDER_FEMALE) {
		self.vw_index = 0;
	}
#endif
#endif
#ifdef mtf_coop
	if (self.#rune_finished)
	{
		sprint(self,2,"Your rune power is gone.\n");
		self.effects = self.effects - (self.effects & 8);
		self.#rune_time = 0;
		self.#rune_finished = 0;
	}
	if (self.#rune_time > time)
	{
		self.effects = self.effects | 8;
		if (self.#rune_time < (time + 1))
			self.#rune_finished = 1;

		if (self.#rune_type == #RUNE_AMMO) {
			self.ammo_shells = self.maxammo_shells;
			self.ammo_nails = self.maxammo_nails;
			self.ammo_cells = self.maxammo_cells;
			self.ammo_rockets = self.maxammo_rockets;
		}
	}
	if (self.speed_finished)
	{
		sprint(self,2,"Your speed power is gone.\n");
		self.effects = self.effects - (self.effects & EF_RED);
		self.speed_time = 0;
		self.speed_finished = 0;
		TeamFortress_SetSpeed(self);
	}
	if (self.speed_time > time)
	{
		self.effects = self.effects | EF_RED;
		self.maxfbspeed = 999;
		self.maxspeed = 999;
		if (self.speed_time < (time + 1))
			self.speed_finished = 1;
	}
	if (mapname == "e1m8")
		self.gravity = .15;
#endif
	if (self.invincible_finished)
	{
		if (self.tfstate & 32)
		{
			if (self.invincible_finished < time + 10)
			{
				self.invincible_finished = time + 666;
			}
		}
		if (self.invincible_finished < time + 3)
		{
			if (self.invincible_time == TF_FLARE_OFF)
			{
				sprint(self, 2, "Protection is almost gone.\n");
				stuffcmd(self, "bf\n");
				sound(self, 0, "items/protect2.wav", TF_FLARE_OFF, TF_FLARE_OFF);
				self.invincible_time = time + TF_FLARE_OFF;
			}
			if (self.invincible_time < time)
			{
				self.invincible_time = time + TF_FLARE_OFF;
				stuffcmd(self, "bf\n");
			}
		}
		if (self.invincible_finished < time)
		{
			self.items = self.items - 1048576;
			self.invincible_time = 0;
			self.invincible_finished = 0;
		}
		if (self.invincible_finished > time)
		{
			self.effects = self.effects | 8;
		}
		else
		{
			lighton = 0;
			te = find(world, classname, "item_tfgoal");
			while (te)
			{
				if (te.owner == self)
				{
					if (te.goal_activation & TF_FLARE_OFF)
					{
						lighton = TF_FLARE_OFF;
					}
				}
				te = find(te, classname, "item_tfgoal");
			}
			if (!lighton)
			{
				self.effects = self.effects - (self.effects & 8);
			}
		}
	}
	if (self.super_damage_finished)
	{
		if (self.tfstate & 128)
		{
			if (self.super_damage_finished == time + 10)
			{
				self.super_damage_finished = time + 666;
			}
		}
		if (self.super_damage_finished < time + 3)
		{
			if (self.super_time == TF_FLARE_OFF)
			{
				sprint(self, 2, "Quad Damage is wearing off.\n");
				stuffcmd(self, "bf\n");
				sound(self, 0, "items/damage2.wav", TF_FLARE_OFF, TF_FLARE_OFF);
				self.super_time = time + TF_FLARE_OFF;
			}
			if (self.super_time < time)
			{
				self.super_time = time + TF_FLARE_OFF;
				stuffcmd(self, "bf\n");
			}
		}
		if (self.super_damage_finished < time)
		{
			self.items = self.items - 4194304;
			self.super_damage_finished = 0;
			self.super_time = 0;
		}
		if (self.super_damage_finished > time)
		{
#ifdef mtf_coop
			self.effects = self.effects | 64;
#else
			self.effects = self.effects | 8;
#endif
		}
		else
		{
			lighton = 0;
			te = find(world, classname, "item_tfgoal");
			while (te)
			{
				if (te.owner == self)
				{
					if (te.goal_activation & TF_FLARE_OFF)
					{
						lighton = TF_FLARE_OFF;
					}
				}
				te = find(te, classname, "item_tfgoal");
			}
			if (!lighton)
			{
#ifdef mtf_coop
				self.effects = self.effects - (self.effects & 64);
#else
				self.effects = self.effects - (self.effects & 8);
#endif
			}
		}
	}
	if (self.radsuit_finished)
	{
		self.air_finished = time + 12;
		if (self.tfstate & 256)
		{
			if (self.radsuit_finished == time + 10)
			{
				self.radsuit_finished = time + 666;
			}
		}
		if (self.radsuit_finished < time + 3)
		{
			if (self.rad_time == TF_FLARE_OFF)
			{
				sprint(self, 2, "Your air supply has run out.\n");
				stuffcmd(self, "bf\n");
				sound(self, 0, "items/suit2.wav", TF_FLARE_OFF, TF_FLARE_OFF);
				self.rad_time = time + TF_FLARE_OFF;
			}
			if (self.rad_time < time)
			{
				self.rad_time = time + TF_FLARE_OFF;
				stuffcmd(self, "bf\n");
			}
		}
		if (self.radsuit_finished < time)
		{
			self.items = self.items - 2097152;
			self.rad_time = 0;
			self.radsuit_finished = 0;
		}
	}
};
#ifdef mega_hats
void () hat_checkowner =
{
	if (self.owner.has_disconnected == 1 || self.owner == world) {
		dremove(self);
		return;
	}
	self.nextthink = time + .5;
};
#endif
#ifdef mtf_coop_rogue
void() xpackEnding;
#endif
void() PlayerPostThink = 
{
	setup_strcat ();
	local vector path2;
#ifdef mega_hats
	local vector tvec;
#endif
#ifdef VWEPS
        if (self.health <= 0)
        {
			if (self.vw_index != 9 && self.vw_index != 11 && self.vw_index != 12 && self.vw_index != 13 && self.vw_index != 16 && self.vw_index != 19)	// bat & chainsaw
				self.vw_index = 31;
        }
#endif
#ifdef botprogs
	if (BotPostFrame ())		// Pablo Bot
	{
		return;
	}
#endif
	if (self.view_ofs == '0 0 0')
	{
		return;
	}
	if (self.deadflag)
	{
		DeadImpulses();
		self.impulse = 0;
		return;
	}
#ifdef mtf_coop_rogue
	if (cutscene_running)
	{
		xpackEnding();
	}
#endif
	if (self.being_juggled > 0)
	{
		if (self.flags & FL_ONGROUND)
		{
			self.being_juggled = 0;	// JUGGLED0rz!
		}
	}
	if (self.jump_flag < -300 && (self.flags & 512) && self.health > 0)
	{
		if (self.watertype == -3)
		{
			sound(self, 4, "player/h2ojump.wav", TF_FLARE_OFF, TF_FLARE_OFF);
		}
		else
		{
			if (self.jump_flag < -650)
			{
				T_Damage(self, world, world, 5);
				sound(self, 2, "player/land2.wav", TF_FLARE_OFF, TF_FLARE_OFF);
				self.deathtype = "falling";
			}
			else
			{
				if (self.playerclass == 8)
				{
					sound(self, 2, "hknight/hit.wav", TF_FLARE_OFF, TF_FLARE_OFF);
					if (!self.is_feigning) {
					if (infokey(world, "prozacserver") == "1") { if( self.velocity_z < 0 ) self.velocity_z = 0; } }
				}
				else
				{
					sound(self, 2, "player/land.wav", TF_FLARE_OFF, TF_FLARE_OFF);
				}
			}
		}
	}
	self.jump_flag = self.velocity_z;
	CheckPowerups();
	W_WeaponFrame();
	if ((self.tools == (self.tools | 32)))
	{
		if (!(self.flags & 16))
		{
			return;
		}
	}
	if ((self.waterlevel > 0))
	{
		if ((self.tools != (self.tools | 32)))
		{
			path2 = aim (self, 1);
			self.angles = vectoangles (path2);
		}
	}
	if (((((self.aqua_sound < time) && (self.watertype == -3)) && (self.waterlevel == 3)) && (self.tools != (self.tools | 32))))
	{
		self.aquamon = 1;
		self.aqua_sound = (time + 5);
	}
	if (self.motd < 22)
	{
		TeamFortress_MOTD();
	}
	else
	{
		if (self.cheat_check == 0)
		{
			self.cheat_check = time + 5;
		}
		else
		{
			if (time > self.StatusRefreshTime && self.StatusBarSize != 0)
			{
				RefreshStatusBar(self);
			}
		}
	}
	if (self.cheat_check <= time)
	{
		TeamFortress_CheckTeamCheats();
		self.cheat_check = time + 2;
	}
	if ((self.Aircraft_Owner && (self.Aircraft_Weapon == 3)))
	{
		Stinger_TryLock ();
	}
	if (self.Aircraft_Owner)
	{
		AC_MaintainAircraft (modelindex_aircraft);
	}
	if ((self.tools == (self.tools | 32)))
	{
		Sub_Speed ();
	}
#ifdef mega_hats
		tvec = self.angles;
		tvec_x = 0;
		if (self.hat == world)  {
			self.hat = spawn();
			self.hat.owner = self;
			setmodel(self.hat, #HAT_MODEL);
			setsize(self.hat, '0 0 30', '0 0 60');
			self.hat.think = hat_checkowner;
			self.hat.nextthink = time + .2;
			if (self.connect_name == "ØavioÒ")
				self.hat.frame = 0;
			else if (self.connect_name == "ÓðáíLite")
				self.hat.frame = 2;
			else
				self.hat.frame = 1;
		}
		else {
			if (self.health <= 0 || self.model != "progs/player.mdl" || self.playerclass == 0) {
				setorigin(self.hat, '0 0 -4000');
				self.hat.angles = self.angles;
			}
			else if (self.frame >= 12 && self.frame <= 16) {
				setorigin(self.hat, self.origin);
				self.hat.angles = self.angles;
			}
			else if (self.frame >= 17 && self.frame <= 28) {		// axe
				makevectors (tvec);
				setorigin(self.hat, (self.origin + v_forward * 3.5) - '0 0 0');
				self.hat.angles = self.angles;
			}
			else if (self.frame == 57) {
				setorigin(self.hat, self.origin - '0 0 36');
				self.hat.angles = tvec;
			}
			else {
				setorigin(self.hat, '0 0 -4000');
				self.hat.angles = self.angles;
			}
		}
#endif
};
void() ClientConnect = 
{
//This is the switch for midair mode -arg
#ifdef midair_switch
	localcmd("sv_progsname qwprogs\n");
	localcmd("timelimit 25\n");
	localcmd("fraglimit 20\n");
#endif
#ifdef botprogs
	ClientInRankings ();
#else
#ifdef mtf_coop
	ClientInRankings2 ();
#endif
#endif
#ifdef mtf_coop
#ifdef HALFLIFE
	local entity relandmark, oself;
	if (#HL_MAP) {
		oself = self;

		relandmark = find(world,classname,"trigger_changelevel");
		while (relandmark)
		{
			if (relandmark.touch == relandmark_touch) {
				self = relandmark;
				self.touch();
				self = oself;
			}
			relandmark = find(relandmark,classname,"trigger_changelevel");
		}
	}
#endif
	local entity te;
	te = find ( world, classname, "monster_score" );
	if (te.netname == "Monsters")
	{
		Coop_ClientFixRankings ( te );
		Monster_Stats_Send_Full( te );
	}
	else
		Monster_Stats_Create ();
#ifdef mtf_coop_expsys
	if (!self.connect_name || self.connect_name == "")
	{
		self.connect_name = strzone(self.netname);
		self.#custom_skin = strzone(self.#custom_skin);
	}
	self.coop_exp = MTF_Coop_GetExperience( self.connect_name );
#ifdef CSQC
	CSQC_SendExperience(self, self.coop_exp);
#endif
	MTF_Coop_SetupInventory( self.connect_name );
	if (Coop_HasMasterSkill( self, #ATTRIB_QUICKSHOT ))
		self.mtf_items |= MTFITEM_LIGHTGUN;
	if (self.coop_exp >= Coop_ExpReq(80))
		self.mtf_items |= MTFITEM_NEEDLER;
#ifdef mtf_coop_achievements
	if (Achievements_Setup(self) == 1) {
	}
#endif
#ifdef mtf_coop_quests
	Quest_SetupPlayer( self );
#endif
#endif
#endif
#ifndef mtf_coop
#ifdef CSQC
	CSQC_SendExperience(self, -666);
#endif
#endif
	num_players = num_players + 1;
	globaluserid = globaluserid + 1;
	self.userid = globaluserid;
	if ((infokey (world, "prozacserver") == "1"))
	{
		self.userid = getuid(self);
	}
	self.vote_wait = (time + 15);
	local string st;
	setup_strcat ();
	if (infokey(world, "fteserver") == "1" || infokey(world, "fteserver") == "on")
	if (FTE_Server)
		Rank_FindStats (self);
	bprint(2, self.netname);
	if (FTE_Server)
		bprint(2, strcat(" joined! (rank: ",ftos(self.global_rank),").\n"));
#ifdef mtf_coop_expsys
	else if (self.netname != "")
		bprint(2, strcat(" joined! (exp: ",ftos(self.coop_exp),").\n"));
#endif
	else
		bprint(2, " joined!\n");
	self.join_time = time;
		self.tfstate = self.tfstate | 4096;
	if (infokey(world, "joinsounds") == "1" || infokey(world, "joinsounds") == "on")
	{
		local string mu;
		mu = infokey(self, "join_sound");
		if (mu != "")
		{
			sound (world, 4.000000, mu, 1.000000, 0.000000);
		}
	}
	if (checkone != 0)
	{
		teamcount1 = 0;
		teamcount2 = 0;
		teamcount3 = 0;
		teamcount4 = 0;
		checkone = 1;
	}
	self.motd = 0;
	self.got_aliases = 0;
	if ( (self.netname == string_null) )
	{
	sprint (self, 0, "You cannot connect with a NULL name bozo. Quit trying to hack. Bye!\n");
	sprint (self, 2, "You cannot connect with a NULL name bozo. Quit trying to hack. Bye!\n");
	bprint (0, "Someone just tried to connect with a NULL name. Dumbass! Begone!\n");
		stuffcmd (self, "disconnect\n");
	}
	local string msg;
	if (infokey(world, "modelcheck") == "1" || infokey(world, "modelcheck") == "on")
	{
	st = infokey (self, "pmodel");
	if ((((((((((st != "13845") && (st != "20572")) && (st != "33168")) && (st != "39460")) && (st != "52964")) && (st != "63186")) && (st != "32907")) && (st != "58759")) && (st != "47373")))
	{
		sprint (self, 0, "You were kicked for using invalid TF pmodel.\n");
		sprint (self, 0, "Have a nice day! :)\n");
		stuffcmd (self, "disconnect\n");
		stuffcmd (self, "help\n");
		bprint (0, self.netname);
		bprint (0, " has been kicked for hacked pmodel.\n");
		return;
	}
	}
	st = infokey (self, "in_speed_hack");
	if ((st != ""))
	{
		sprint (self, 0, "You were banned for using hacked qwcl.exe .\n");
		sprint (self, 0, "Have a nice day! :)\n");
		stuffcmd (self, "disconnect\n");
		stuffcmd (self, "help\n");
		bprint (0, self.netname);
		bprint (0, " has been banned for speed cheat.\n");
		msg = infokey (self, "ip");
		localcmd ("addip ");
		localcmd (msg);
		localcmd ("\n");
		localcmd ("writeip ");
		localcmd (msg);
		localcmd ("\n");
		return;
	}
	st = infokey (self, "ser");
	if ((st != ""))
	{
		sprint (self, 0, "You were banned for using hacked qwcl.exe .\n");
		sprint (self, 0, "Have a nice day! :)\n");
		stuffcmd (self, "disconnect\n");
		stuffcmd (self, "help\n");
		bprint (0, self.netname);
		bprint (0, " has been banned for speed cheat.\n");
		msg = infokey (self, "ip");
		localcmd ("addip ");
		localcmd (msg);
		localcmd ("\n");
		localcmd ("writeip ");
		localcmd (msg);
		localcmd ("\n");
		return;
	}
	st = infokey(self, "sbar_res");
	if (st == "768")
	{
		self.StatusBarRes = 8;
	}
	else
	{
		if (st == "600")
		{
			self.StatusBarRes = 7;
		}
		else
		{
			if (st == "480")
			{
				self.StatusBarRes = 6;
			}
			else
			{
				if (st == "400")
				{
					self.StatusBarRes = 5;
				}
				else
				{
					if (st == "384")
					{
						self.StatusBarRes = 4;
					}
					else
					{
						if (st == "350")
						{
							self.StatusBarRes = 3;
						}
						else
						{
							if (st == "300")
							{
								self.StatusBarRes = 2;
							}
							else
							{
								if (st == "240")
								{
									self.StatusBarRes = TF_FLARE_OFF;
								}
								else
								{
									self.StatusBarRes = 0;
								}
							}
						}
					}
				}
			}
		}
	}
	st = infokey(self, "sbar_size");
	self.StatusBarSize = stof(st);
	if (self.StatusBarSize > 2 || self.StatusBarSize < 0)
	{
		self.StatusBarSize = 0;
	}
	self.has_disconnected = 0;
	if (intermission_running)
	{
		GotoNextMap();
	}
};
#ifdef botprogs
void (entity whee) RegeneratePlayerList;
#endif
void() ClientDisconnect = 
{
#ifdef botprogs
	if (self.ishuman)
	{
		clientSetFree (self.fClientNo);
	}
#else
#ifdef mtf_coop
	clientSetFree2 (self.fClientNo);
#endif
#endif
#ifdef mtf_coop
	Survival_MakeDummy( 1 );
#endif
	num_players = num_players - 1;
	if ((self.has_voted == 1))
	{
		num_votes = num_votes - 1;
	}
	if (FTE_Server)
		Rank_UpdateStats(self);
	self.userid = 0;
	if (self.team_no == 1) { teamcount1 = teamcount1 - 1; }
	if (self.team_no == 2) { teamcount2 = teamcount2 - 1; }
	if (self.team_no == 3) { teamcount3 = teamcount3 - 1; }
	if (self.team_no == 4) { teamcount4 = teamcount4 - 1; }
	local entity te;
#ifdef newsounds2
	if (random() > 0.5)
		sound(self, 4, "misc/eject.wav", TF_FLARE_OFF, 0);
	else
#endif
	sound(self, 4, "misc/eject.wav", TF_FLARE_OFF, 0);
	self.has_disconnected = TF_FLARE_OFF;
#ifdef mtf_coop
	self.health = 0;
	if (survival_mode)
		Survival_Fail();
#endif
	TeamFortress_RemoveTimers();
	if ((self.tools == (self.tools | 32)))
	{
		exit_vehicle ();
	}
	te = find (world, classname, "player_prop");
	while (te)
	{
		if ((te.owner == self))
		{
			dremove (te);
		}
		te = find (te, classname, "player_prop");
	}
	te = find (world, classname, "camera");
	while (te)
	{
		if ((te.owner == self))
		{
			dremove (te);
		}
		te = find (te, classname, "camera");
	}
	te = find (world, classname, "camera_base");
	while (te)
	{
		if ((te.owner == self))
		{
			dremove (te);
		}
		te = find (te, classname, "camera_base");
	}
	te = find (world, classname, "drop4");
	while (te)
	{
		if ((te.real_owner == self))
		{
			kill_medpack(te);
		}
		te = find (te, classname, "trip_bomb");
	}

	te = find (world, classname, "trip_bomb");
	while (te)
	{
		if ((te.real_owner == self))
		{
			TF_T_Damage (te, world, world, 500, 0, 0);
		}
		te = find (te, classname, "trip_bomb");
	}
	te = find(world, classname, "building_dispenser");
	while (te)
	{
		if (te.real_owner == self)
		{
			TF_T_Damage(te, world, world, 500, 0, 0);
		}
		te = find(te, classname, "building_dispenser");
	}
	te = find(world, classname, "building_sentrygun");
	while (te)
	{
		if (te.real_owner == self)
		{
			TF_T_Damage(te, world, world, 500, 0, 0);
		}
		te = find(te, classname, "building_sentrygun");
	}
	te = find (world, classname, "building_tesla");
	while (te)
	{
		if ((te.real_owner == self))
		{
			TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
		}
		te = find (te, classname, "building_tesla");
	}
	te = find (world, classname, "building_camera");
	while (te)
	{
		if ((te.real_owner == self))
		{
			TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
		}
		te = find (te, classname, "building_camera");
	}
	te = find (world, classname, "building_teleporter");
	while (te)
	{
		if ((te.real_owner == self))
		{
			TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
		}
		te = find (te, classname, "building_teleporter");
	}
	te = find (world, classname, "building_fieldgen");
	while (te)
	{
		if ((te.real_owner == self))
		{
			TF_T_Damage (te, world, world, 500, TF_FLARE_LIT, TF_FLARE_LIT);
		}
		te = find (te, classname, "building_fieldgen");
	}
	te = find(world, classname, "detpack");
	while (te)
	{
		if (te.owner == self)
		{
			if (te.weaponmode == TF_FLARE_OFF)
			{
				TeamFortress_SetSpeed(te.enemy);
				dremove(te.oldenemy);
				dremove(te.observer_list);
			}
			dremove(te);
			te = world;
		}
		te = find(te, classname, "detpack");
	}
	te = find (world, classname, "drop1");
	while (te)
	{
		if ((te.owner == self))
		{
			dremove (te);
			te = world;
		}
		te = find (te, classname, "drop1");
	}
	te = find (world, classname, "bot");
	while (te)
	{
		if ((te.owner == self))
		{
			dremove (te);
			te = world;
		}
		te = find (te, classname, "bot");
	}
	te = find(world, classname, "beartrap");   // remove the beartraps for disconnected player. -arg
	while (te)
	{
		if (te.owner == self)
		{
			if (te.weaponmode == TF_FLARE_OFF)
			{
				TeamFortress_SetSpeed(te.enemy);
				dremove(te.oldenemy);
				dremove(te.observer_list);
			}
			dremove(te);
			te = world;
		}
		te = find(te, classname, "beartrap");
	}
	te = find(world, classname, "turret"); //remove auto sentry turrets for disconnected player -arg
	while (te)
	{
		if (te.owner == self)
		{
			if (te.weaponmode == TF_FLARE_OFF)
			{
				TeamFortress_SetSpeed(te.enemy);
				dremove(te.oldenemy);
				dremove(te.observer_list);
			}
			dremove(te);
			te = world;
		}
		te = find(te, classname, "turret");
	}
	while (te)
	{
		if (te.owner == self)
		{
			if (te.weaponmode == TF_FLARE_OFF)
			{
				TeamFortress_SetSpeed(te.enemy);
				dremove(te.oldenemy);
				dremove(te.observer_list);
			}
			dremove(te);
			te = world;
		}
		te = find(te, classname, "turret_base"); //remove turret base when disconnected or kicked. -arg
	}
	set_suicide_frame();
#ifdef mtf_coop
#ifdef mtf_coop_expsys
	strunzone(self.connect_name);
	if (self.#custom_skin != "")
		strunzone(self.#custom_skin);
#endif
#endif
	self.netname = string_null;
	self.team_no = 0;
	self.solid = 0;
	setsize(self, '0 0 0', '0 0 0');
};
void() Grapple_Track;
void() Reset_My_Grapple;
#ifdef mtf_coop_expsys
void (entity plyr, string nname, float exp) MTF_Coop_PreWriteExperience;
#endif
#ifdef PL_FEM
#include "fem_obits.qc"
void FemaleClientObituary(entity targ, entity attacker );
#endif
void(entity targ, entity attacker) ClientObituary = 
{
	local float rnum;
	local string deathstring;
	local string deathstring2;
	local entity b_ent;
	setup_strcat ();
	if (prematch)
	{
		return;
	}
#ifdef mtf_coop_hipnotic
	if (targ.classname == "trap_spike_mine" && attacker.classname == "trap_spike_mine")
		return;
#endif
	if (targ.classname == "player_prop")
		return;
	if (targ.netname == "teleporter")
		return;
	if (targ.think == Grapple_Track)
		return;

	if (FTE_Server)
		Rank_AddDeaths(targ, 1);
	if (attacker != targ)
		Record_Check(attacker, (attacker.frags + 1), #RECORD_FRAGS);
	if (attacker.classname == "building_sentrygun")
		if (attacker.real_owner) {
			b_ent = attacker;
			attacker = attacker.real_owner;
		}
	if (deathmsg > 0 && deathmsg < 500 && targ.th_die != AC_Destroyed && targ.classname != "monster_rat" && attacker.classname != "info_tfgoal")
	{
		if (attacker)
		{
			attacker.num_kills = attacker.num_kills + 1;
			if (attacker.fertracker != 1)
			{
				attacker.fertracker = 1;
				fertimer (attacker);
			}
			if (attacker == targ)
			{
				attacker.num_kills = attacker.num_kills - 1;
			}
			if (FTE_Server && attacker != targ)
				Rank_AddFrags(attacker, 1);
				if (targ.classname == "building_dispenser") {
				attacker.num_kills = attacker.num_kills - 1; }
				else if (targ.think == DroneJet) {
				attacker.num_kills = attacker.num_kills - 1; }
				else if (targ.touch == KickHead) {
				attacker.num_kills = attacker.num_kills - 1; }
				else if (targ.th_die == Reset_My_Grapple) {
				attacker.num_kills = attacker.num_kills - 1; }
#ifndef mtf_coop
			if (targ.classname == "monster_shambler")
			{
				attacker.num_kills = attacker.num_kills + 1336;
			}
#endif
			attacker.killstack = attacker.killstack + 1;
			if (attacker.netname) { 	// we don't want world entities getting these hehe
			if (attacker.killstack == 7)
			{
				bprint (1, attacker.netname);
				bprint (1.000000, " is on a rampage!\n");
				sound (world, 4.000000, "misc/rampage.wav", 1.000000, 0.000000);
			}
			if (attacker.killstack == 12)
			{
				bprint (1, attacker.netname);
				bprint (1.000000, " is owning all you noobs up!\n");
				sound (world, 4.000000, "misc/godlike.wav", 1.000000, 0.000000);
			}
			if (attacker.killstack == 19)
			{
				bprint (1, attacker.netname);
				bprint (1.000000, " knows how to freakin' play!\n");
				sound (world, 4.000000, "misc/holyshit.wav", 1.000000, 0.000000);
			}
			}
		}
	}
#ifdef mtf_coop_lms
	if (lms_entity != world) {
		if (targ.classname == "player")
			targ.#lms_lives = targ.#lms_lives - 1;
	}
#endif
	if (b_ent != world)
		attacker = b_ent;
	if (targ.ischangingteams > 0)
	{
		teamchangetimer(targ);

	}
	if (attacker.ischangingteams > 0)
	{
		if (attacker.health < 1) {
		}
	}
	if (attacker.classname == "bot")
	{
		if (attacker.is_active_mini == 1) {
			attacker.netname = attacker.real_owner.netname;
			attacker.real_owner.frags = attacker.real_owner.frags + 1;
			attacker.real_owner.real_frags = attacker.real_owner.real_frags + 1;
		}
	}
#ifdef mtf_coop_expsys
	if (attacker.#is_minion == #TRUE) {
		if (attacker.owner == world)
			return;
		if (targ != self.owner) {
			attacker.owner.frags = attacker.owner.frags + 1;
			attacker.owner.real_frags = attacker.owner.real_frags + 1;
			MTF_Coop_AddExperience ( attacker.owner, targ, FALSE );
			MTF_Coop_PreWriteExperience( attacker.owner, attacker.owner.connect_name, attacker.owner.coop_exp );
			sprint(attacker.owner, 2, "One of your minions has decomposed.\n");
		}
		else
			return;
	}
	if (targ.#is_minion == #TRUE)
	{
		if (targ.owner == world)
			return;
		targ.owner.#minions -= 1;
		return;
	}
#endif

	if (targ.being_juggled > 1 && targ.classname == "player" && attacker.classname == "player" && targ != attacker)
	{
		bprint(2,targ.netname);
		bprint(2," got JUGGLED by ");
		bprint(2,attacker.netname);
		bprint(2,"\n");
		sound (world, 4, "misc/juggled2.wav", 1, 0);
	}
#ifdef mtf_coop
	if (targ.being_juggled > 1 && targ.is_monster == 1 && attacker.classname == "player" && targ != attacker)
	{
		bprint(2,targ.netname);
		bprint(2," got ÊÕÇÇÌÅÄ by ");
		bprint(2,attacker.netname);
		bprint(2,"\n");
		sound (world, 4, "misc/juggled2.wav", 1, 0);
		targ.being_juggled = 0;
#ifdef mtf_coop_expsys
		Achievements_Change( attacker, world, ACHIEVEMENTS_ADD, ACHIEVEMENT_JUGGLER, 1 );
#endif
	}
#endif
#ifdef PL_FEM
	if (targ.gender == GENDER_FEMALE) {
		FemaleClientObituary( targ, attacker );
		return;
	}
#endif
	rnum = random();
#ifdef mtf_coop
	if (targ.classname == "player" || targ.is_monster == 1)
#else
	if (targ.classname == "player")
#endif
	{
#ifdef mtf_coop_expsys
	if (attacker.coop_exp != -1 && attacker.classname == "player" && targ.is_monster == 1) {
		attacker.coop_exp += 5;
		MTF_Coop_AddExperience ( attacker, targ, FALSE );
		MTF_Coop_PreWriteExperience( attacker, attacker.connect_name, attacker.coop_exp );
	}
#endif
		if (attacker.classname == "teledeath")
		{
#ifdef mtf_coop
			if (targ.is_monster)
				bprint(TF_FLARE_OFF, GetMonsterPowers(targ, 0));
#endif
			bprint(TF_FLARE_OFF, targ.netname);
			bprint(TF_FLARE_OFF, " got in the way of ");
			bprint(TF_FLARE_OFF, attacker.owner.netname);
			bprint(TF_FLARE_OFF, "\n");
			if (attacker.owner.team_no != targ.team_no || attacker.owner.team_no < TF_FLARE_OFF)
			{
				attacker.owner.real_frags = attacker.owner.real_frags + TF_FLARE_OFF;
			}
			if (!(toggleflags & 128))
			{
				attacker.owner.frags = attacker.owner.real_frags;
			}
			return;
		}
		if (attacker.classname == "teledeath2")
		{
			bprint(TF_FLARE_OFF, "Satan's power deflects ");
			bprint(TF_FLARE_OFF, targ.netname);
			bprint(TF_FLARE_OFF, "'s telefrag\n");
			targ.real_frags = targ.real_frags - TF_FLARE_OFF;
			if (!(toggleflags & 128))
			{
				targ.frags = targ.real_frags;
			}
			logfrag(targ, targ);
			return;
		}
		if (attacker.classname == "info_tfgoal")
		{
			if (attacker.deathtype != "")
			{
				bprint(TF_FLARE_OFF, targ.netname);
				bprint(TF_FLARE_OFF, attacker.deathtype);
			}
			logfrag(targ, targ);
			return;
		}
#ifdef minipets
		if (attacker.classname == "player" || attacker.classname == "bot" || attacker.classname == "minifiend" || attacker.classname == "trip_bomb")
#else
		if (attacker.classname == "player" || attacker.classname == "bot")
#endif
		{
			if (targ == attacker)
			{
				attacker.real_frags = attacker.real_frags - TF_FLARE_OFF;
				if (!(toggleflags & 128))
				{
					attacker.frags = attacker.real_frags;
				}
				bprint(TF_FLARE_OFF, targ.netname);
				if (deathmsg == 8)
				{
					deathstring = " grenades himself.\n";
				}
				else
				{
																if ((deathmsg == 65))
																{
																	deathstring = " Has no sense of direction.\n";
																}
																else
																{
												if ((deathmsg == 58))
												{
													deathstring = " Examines his torpedo too closely.\n";
												}
												else
												{
				if ((deathmsg == 69))
				{
					deathstring = " tries to ride a meteor.\n";
				}
				else
				{
				if ((deathmsg == 68))
				{
					deathstring = " Didnt get far enough from his bomb.\n";
				}
				else
				{
				if ((deathmsg == 55))
				{
					deathstring = " Had a stinger turn on him.\n";
				}
				else
				{
				if ((deathmsg == 50))
				{
					deathstring = " gets too close to his laser trip wire!\n";
				}
				else
				{
				if ((deathmsg == 59))
				{
					deathstring = " caught a chunk of shrapnel.\n";
				}
				else
				{
				if ((deathmsg == 67))
				{
					deathstring = " Had a sidewinder turn on him.\n";
				}
				else
				{

					if (deathmsg == 52)
					{
						deathstring = " tries to fly with his turretizing tesla.\n";
					}
					else
					{
					if (deathmsg == 43)
					{
						deathstring = " has himself bombed.\n";
					}
					else
					{
						if (deathmsg == 45)
						{
							deathstring = " hugs his proximity grenade.\n";
						}
						else
						{
							if (deathmsg == 9)
							{
								deathstring = " nails himself.\n";
							}
							else
							{
								if (deathmsg == 10)
								{
									deathstring = " is blown to bits.\n";
								}
								else
								{
									if (deathmsg == 11)
									{
										deathstring = " pipebombs himself...\nWhat a dumb-ass!\n";
									}
									else
									{
										if (deathmsg == 24)
										{
											deathstring = " gags on his own gas... pew!\n";
										}
										else
										{
											if (deathmsg == 30)
											{
												deathstring = " nukes his own ammo.\n";
											}
											else
											{
												if (deathmsg == 35)
												{
													deathstring = " flash grenade himself to death.n";
												}
												else
												{
													if (deathmsg == 31)
													{
														deathstring = " detonates an ammo box too close to him.\n";
													}
													else
													{
														if (deathmsg == 12)
														{
															deathstring = " detpacks himself\n That was smart!\n";
														}
														else
														{
															if (deathmsg == 13)
															{
																deathstring = " died impossibly!\n";
															}
															else
															{
																if (deathmsg == 6 || deathmsg == 59)
																{
																	if (rnum <= 0.5)
																	{
																		deathstring = " checks if his weapon is loaded.\n";
																	}
																	else
																	{
																		deathstring = " hates himself.\n";
																	}
																}
																else
																{
																	if (deathmsg == 41)
																	{
																		deathstring = "'s Laser Drone malfunctioned.\n";
																	}
																	else
																	{
																		if (deathmsg == 33)
																		{
																			deathstring = " chars himself with an incendiary rocket.\n";
																		}
																		else
																		{
																			if (deathmsg == 5)
																			{
																				deathstring = " tries to put the pin back in.\n";
																			}
																			else
																			{
																				if (deathmsg == 15)
																				{
																					if (attacker.playerclass == TF_FLARE_OFF)
																					{
																						deathstring = "'s JetPack malfunctions.\n";
																					}
																					else
																					{
																						deathstring = " bakes himself\n";
																					}
																				}
																				else
																				{
																					if (deathmsg == 7 && targ.waterlevel > TF_FLARE_LIT)
																					{
																						bprint(TF_FLARE_OFF, " shocks himself to death.\n");
																						return;
																					}
																					else
																					{
																						if (deathmsg == 40)																					
																						{
																							deathstring = " couldn't outrun his airspam.\n";																							
																						}
																						else
																						{
																							if (deathmsg == 201)
																							{
																								deathstring = " used his dispenser for all the wrong reasons.\n";																								
																							}
																						}
																					}
																				}
																			}
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				} } } }	// BTF self-kill msgs
				} } } } }	// BTF Helo self-kill msgs
				}	// LTB
				bprint(TF_FLARE_OFF, deathstring);
				return;
			}
			else
			{
				if (teamplay && attacker.team_no == targ.team_no && attacker.team_no > 0)
				{
					if (attacker.team_no > 0 && attacker.team_no == targ.team_no)
					{
						attacker.real_frags = attacker.real_frags - TF_FLARE_OFF;
					}
					else
					{
						attacker.real_frags = attacker.real_frags + TF_FLARE_OFF;
					}
					if (!(toggleflags & 128))
					{
						attacker.frags = attacker.real_frags;
					}
					if (rnum < 0.25)
					{
						deathstring = " mows down a teammate.\n";
					}
					else
					{
						if (rnum < 0.5)
						{
							deathstring = " checks his glasses.\n";
						}
						else
						{
							if (rnum < 0.75)
							{
								deathstring = " gets a frag for the other team.\n";
							}
							else
							{
								deathstring = " loses another friend.\n";
							}
						}
					}
					if (deathmsg == 23)
					{
						bprint(TF_FLARE_OFF, targ.netname);
						bprint(TF_FLARE_OFF, " didn't survive the operation.\n");
						return;
					}
					bprint(TF_FLARE_OFF, attacker.netname);
					bprint(TF_FLARE_OFF, deathstring);
					return;
				}
				else
				{
					attacker.real_frags = attacker.real_frags + TF_FLARE_OFF;
					logfrag(attacker, targ);
					if (!(toggleflags & 128))
					{
						attacker.frags = attacker.real_frags;
					}
#ifdef mtf_coop
					if (deathmsg == 449)
					{
						deathstring = " was shredded by ";
						deathstring2 = "'s chainsaw.\n";
					}
#endif
					if (deathmsg == 43)
					{
						deathstring = " was bombed by ";
						deathstring2 = "'s AirStrike call.\n";
					}
					if (deathmsg == 59)
					{
						deathstring = " blows up with ";
						deathstring2 = " for king and country!\n";
					}
					if ((deathmsg == 65))
					{
						deathstring = " feels the hot lead of ";
						deathstring2 = "'s AAGUN\n";
					}
					if ((deathmsg == 58))
					{
						deathstring = " Is made into fish chum by ";
						deathstring2 = "'s torpedo.\n";
					}
					if ((deathmsg == 57))
					{
						deathstring = " got too close to ";
						deathstring2 = "'s rotor blade.\n";
					}
					if ((deathmsg == 56))
					{
						deathstring = " eats too much lead from ";
						deathstring2 = "'s 30mm rotary cannon.\n";
					}
					if ((deathmsg == 55))
					{
						deathstring = " was stung by ";
						deathstring2 = "'s stinger.\n";
					}
					if ((deathmsg == 68))
					{
						deathstring = " was pounded by ";
						deathstring2 = "'s bomb.\n";
					}
					if (((deathmsg == 67) || (deathmsg == 66)))
					{
						deathstring = " was caught by ";
						deathstring2 = "'s sidewinder.\n";
					}
					if ((deathmsg == 50))
					{
						deathstring = " is smeared all over the walls by ";
						deathstring2 = "'s laser trip wire!\n";
					}


					if (deathmsg == 45)
					{
						deathstring = " gets too friendly with ";
						deathstring2 = "'s Proxi grenade.\n";
					}
					if (deathmsg == 46)
					{
						deathstring = " gets shredded by ";
						deathstring2 = "'s 20mm cannon.\n";
					}
					if (deathmsg == 446)
					{
						deathstring = " has the crap beaten out of him by ";
						deathstring2 = "'s bat.\n";
					}
					if (deathmsg == 447)
					{
						deathstring = " is taken out gangsta style by ";
						deathstring2 = "\n";
					}
					if ((deathmsg == 44.000000))
					{
						deathstring = "'s got lethally demoralized by ";
						deathstring2 = "'s auto sentry gun.\n";
					}
					if ((deathmsg == 202))
					{
						deathstring = "'s ass was clamped off by ";
						deathstring2 = "'s bear trap.\n";
					}
					if ((deathmsg == 203))
					{
						deathstring = "'s chokes to death on ";
						deathstring2 = "'s bad ass farts.\n";
					}
					if ((deathmsg == 204))
					{
						deathstring = "'s was spun like a record baby by ";
						deathstring2 = "'s gravity well.\n";
					}
					if ((deathmsg == 205))
					{
						deathstring = "'s was pooned painkeep style by ";
						deathstring2 = "'s harpoon.\n";
					}
					if (deathmsg == 8)
					{
						deathstring = " tries to hatch ";
						deathstring2 = "'s grenade.\n";
					}
					if (deathmsg == 100)
					{
						deathstring = " is fried by ";
						deathstring2 = "'s lightning gun.\n";
					}
					else
					{
						if (deathmsg == 9)
						{
							deathstring = " gets perforated by ";
							deathstring2 = "'s nail grenade.\n";
						}
						else
						{
							if (deathmsg == 10)
							{
								deathstring = " gets juiced by ";
								deathstring2 = "'s Mirv grenade.\n";
							}
							else
							{
								if (deathmsg == 40)
								{
									deathstring = " is shreaded by ";
									deathstring2 = "'s AirMirv.\n";
								}
								else
								{
									if (deathmsg == 11)
									{
										deathstring = " is shreaded by ";
										deathstring2 = "'s pipebomb trap\n";
									}
									else
									{
										if (deathmsg == 24)
										{
											deathstring = " sniffs to much of ";
											deathstring2 = "'s glue.\n";
										}
										else
										{
											if (deathmsg == 30)
											{
												deathstring = "'s gets vaporized by ";
												deathstring2 = "'s EMP grenade.\n";
											}
											else
											{
												if (deathmsg == 35)
												{
													deathstring = "'s brain is fried by ";
													deathstring2 = "'s flash grenade.\n";
												}
												else
												{
													if (deathmsg == 31)
													{
														deathstring = " stands near some ammo as ";
														deathstring2 = "'s EMP nukes it.\n";
													}
													else
													{
														if (deathmsg == 12)
														{
															deathstring = " is nuked by ";
															deathstring2 = "'s detpack.\n";
														}
														else
														{
															if (deathmsg == 204)
															{
																deathstring = " gets squarshed by ";
																deathstring2 = "'s gravity well.\n";
															}
															else
															{
																if (deathmsg == 13)
																{
																	deathstring = " dies from ";
																	deathstring2 = "'s social disease.\n";
																	sound(targ, 0, "player/mpain6.wav", TF_FLARE_OFF, TF_FLARE_OFF);
																}
																else
																{
																	if (deathmsg == 14)
																	{
																		deathstring = " escapes infection from ";
																		deathstring2 = " by dying first.\n";
																	}
																	else
																	{
																		if (deathmsg == 5)
																		{
																			deathstring = " swallows ";
																			deathstring2 = "'s grenade.\n";
																			if (targ.health < -40)
																			{
																				deathstring = " was split in half by ";
																				deathstring2 = "'s grenade.\n";
																			}
																		}
																		else
																		{
																			if (deathmsg == 6)
																			{
																				deathstring = " is reamed by ";
																				deathstring2 = "'s rocket.\n";
																				if (targ.health < -40)
																				{
																					deathstring = "'s bunghole was ripped by ";
																					deathstring2 = "'s rocket.\n";
																				}
																			}
																			else
																			{
																				if (deathmsg == 41)
																				{
																					deathstring = " was killed by ";
																					deathstring2 = "'s Laser Drone.\n";
																					if (targ.health < -40)
																					{
																						deathstring = " was vaporized by ";
																						deathstring2 = "'s Laser Drone.\n";
																					}
																				}
																				else
																				{
																					if (deathmsg == 42)
																					{
																						deathstring = " was torn up by an enemy Rottweiler.";
																						deathstring2 = "\n";
																					}
																					else
																					{
																						if (deathmsg == 44)
																						{
																							deathstring = " was stopped by an enemy autoturret.";
																							deathstring2 = ".\n";
																						}
																						else
																						{
																							if (deathmsg == 15)
																							{
																								if (rnum < 0.2)
																								{
																									deathstring = " burns to death by ";
																									deathstring2 = "'s flame.\n";
																								}
																								else
																								{
																									if (rnum < 0.4)
																									{
																										deathstring = " is fried by ";
																										deathstring2 = "'s fire.\n";
																									}
																									else
																									{
																										if (rnum < 0.6)
																										{
																											deathstring = " is boiled alive by ";
																											deathstring2 = "'s heat.\n";
																										}
																										else
																										{
																											if (rnum < 0.8)
																											{
																												deathstring = " is cremated by ";
																												deathstring2 = "'s incinerator.\n";
																											}
																											else
																											{
																												deathstring = " is grilled by ";
																												deathstring2 = "'s BBQ.\n";
																											}
																										}
																									}
																								}
																							}
																							else
																							{
																								if (deathmsg == 17)
																								{
																									if (attacker.playerclass == 8)
																									{
																										deathstring = " was stabbed by ";
																									}
																									else
																									{
																										deathstring = " was slit open by ";
																									}
																									deathstring2 = ".\n";
																								}
																								else
																								{
																									if (deathmsg == 32)
																									{
																										deathstring = " was spanner-whacked by ";
																										deathstring2 = ".\n";
																									}
																									else
																									{
																										if (deathmsg == TF_FLARE_OFF)
																										{
																											deathstring = " was swiss-cheesed by ";
																											deathstring2 = "'s bird gun.\n";
																										}
																										else
																										{
																											if (deathmsg == 2)
																											{
																												deathstring = "'s head is popped by ";
																												deathstring2 = "'s shotgun.\n";
																											}
																											else
																											{
																												if (deathmsg == 3)
																												{
																													deathstring = " was bustacapped by ";
																													deathstring2 = ".\n";
																												}
																												else
																												{
																													if (deathmsg == 4)
																													{
																														deathstring = " was perforated by ";
																														deathstring2 = "'s lava nailgun.\n";
																													}
																													else
																													{
																														if (deathmsg == 7)
																														{
																															deathstring = " swims with ";
																															deathstring2 = "'s toaster.\n";
																														}
																														else
																														{
																															if (deathmsg == 21)
																															{
																																deathstring = " grappled with ";
																																deathstring2 = ".\n";
																															}
																															else
																															{
																																if (deathmsg == 18)
																																{
																																	if (rnum <= 0.3)
																																	{
																																		deathstring = " gets a sucking chest wound from ";
																																		deathstring2 = ".\n";
																																	}
																																	else
																																	{
																																		if (rnum <= 0.6)
																																		{
																																			deathstring = "'s liver is blown out by ";
																																			deathstring2 = ".\n";
																																		}
																																		else
																																		{
																																			deathstring = "'s chest explodes from ";
																																			deathstring2 = "'s sniper round.\n";
																																		}
																																	}
																																}
																																else
																																{
																																	if (deathmsg == 29)
																																	{
																																		if (rnum <= 0.5)
																																		{
																																			deathstring = " is beheaded by ";
																																			deathstring2 = "'s round.\n";
																																		}
																																		else
																																		{
																																			deathstring = "'s labotomized by ";
																																			deathstring2 = "'s sniper round.\n";
																																		}
																																	}
																																	else
																																	{
																																		if ((deathmsg == 51))
																																		{
																																			if ((rnum <= 0.5))
																																			{
																																				deathstring = " was shocked to death by ";
																																				deathstring2 = "'s tesla coil.\n";
																																			}
																																			else
																																			{
																																				deathstring = "'s was obliterated by ";
																																				deathstring2 = "'s tesla coil.\n";
																																			}
																																		} else {
																																										if ((deathmsg == 52))
																																										{
																																											if ((rnum < 0.5))
																																											{
																																												deathstring = " is disentegrated by ";
																																												deathstring2 = "'s Sentry Point Defense System.\n";
																																											}
																																											else
																																											{
																																												deathstring = " is obliterated by ";
																																												deathstring2 = "'s sentry gun.\n";
																																											}
																																										}
#ifdef mtf_coop																																									
	else if (deathmsg == 1124) {
		deathstring = " is pinned by ";
		deathstring2 = "'s needler.\n";
	}
	else if (deathmsg == 1125) {
		deathstring = " is set aflare by ";
		deathstring2 = "'s flare gun.\n";
	}
	else {
#elseif
																																										else {
#endif																																										
																																		if (deathmsg == 28)
																																		{
																																			if (rnum <= 0.5)
																																			{
																																				deathstring = " is neutered by ";
																																				deathstring2 = ".\n";
																																			}
																																			else
																																			{
																																				deathstring = "'s legs explode open from ";
																																				deathstring2 = "'s shot.\n";
																																			}
																																		}
																																		else
																																		{
																																			if (deathmsg == 19)
																																			{
																																				deathstring = " enjoys ";
																																				deathstring2 = "'s machinegun.\n";
																																			}
																																			else
																																			{
																																				if (deathmsg == 20)
																																				{
																																					deathstring = " torso is removed by ";
																																					deathstring2 = ".\n";
																																				}
																																				else
																																				{
																																					if (deathmsg == 22)
																																					{
																																						deathstring = " is ass-knifed by ";
																																						deathstring2 = ".\n";
																																						sound(targ, 0, "player/mpain6.wav", TF_FLARE_OFF, TF_FLARE_OFF);
																																					}
																																					else
																																					{
																																						if (deathmsg == 25)
																																						{
																																							deathstring = " is over-dosed by ";
																																							deathstring2 = "'s ludes.\n";
																																						}
																																						else
																																						{
																																							if (deathmsg == 26)
																																							{
																																								deathstring = " spews juice thru holes from ";
																																								deathstring2 = "'s railgun.\n";
																																							}
																																							else
																																							{
																																								if (deathmsg == 33)
																																								{
																																									deathstring = " gets cooked by ";
																																									deathstring2 = "'s incendiary rocket.\n";
																																								} 
																																								// pablo. spike trap death msg.
																																								else
																																								{
																																									if (deathmsg == 200)
																																									{
																																										deathstring = "'s leg was amputated by ";
																																										deathstring2 = "'s spike.\n";
																																									}
																																									// pablo. dispenser death msg.
																																									else
																																									{
																																										if (deathmsg == 201)
																																										{
																																											deathstring = " thought ";
																																											deathstring2 = "'s dispenser was a mechanical bull.\n";
																																										}
																																									}
																																								}
																																							}																																						
																																						}
																																					}
																																				}
																																			}
																																		}
																																	}
																																}
																															}
																														}
																													}
																												}
																											}
																										}
																									}
																								}
																							}
																						}
																					}
																				}
																			}
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						} } }
					}
#ifdef mtf_coop
					if (targ.is_monster)
						bprint(TF_FLARE_OFF, GetMonsterPowers(targ, 0));
#endif
					bprint(TF_FLARE_OFF, targ.netname);
#ifdef mtf_coop
					if (targ.is_monster)
						if (targ.lives > 0) {
							bprint(2, "(");
							bprint(2, ftos(targ.lives));
							bprint(2, ")");
						}
#endif
					bprint(TF_FLARE_OFF, deathstring);
#ifdef mtf_coop
					if (attacker.is_monster)
						bprint(TF_FLARE_OFF, GetMonsterPowers(attacker, 0));
#endif
#ifdef mtf_coop
					if (targ.is_monster == 1 && targ.#other_attacker != world && targ.#other_attacker != attacker && targ.#other_attacker.classname == "player")
					{
						bprint(TF_FLARE_OFF, targ.#other_attacker.connect_name);
						bprint(TF_FLARE_OFF, " and ");
						targ.#other_attacker = world;
					}
#endif
					bprint(TF_FLARE_OFF, attacker.netname);
					bprint(TF_FLARE_OFF, deathstring2);
				}
			}
			return;
		}
		else
		{
			if (((attacker.classname == "building_sentrygun") || (attacker.classname == "building_tesla")))
			{
				if (targ == attacker.real_owner)
				{
					if ((deathmsg == 34))
					{
						deathstring = " gets wasted by his sentry gun\nDumb-ass!\n";
					}
					else
					{
						if ((deathmsg == 27))
						{
							deathstring = " crossed his sentry gun's line of fire.\n";
						}
						else
						{
							if ((deathmsg == 52))
							{
								deathstring = " was electrocuted by his own tesla coil.\n";
							}
						}
					}
					bprint(TF_FLARE_OFF, targ.netname);
					bprint(TF_FLARE_OFF, deathstring);
				}
				else
				{
					attacker.real_owner.real_frags = attacker.real_owner.real_frags + TF_FLARE_OFF;
					logfrag(attacker.real_owner, targ);
					if (!(toggleflags & 128))
					{
						attacker.real_owner.frags = attacker.real_owner.real_frags;
					}
					if (deathmsg == 34)
					{
						deathstring = " is creamed by ";
						deathstring2 = "'s sentry gun.\n";
					}
					else
					{
						if (deathmsg == 27)
						{
							deathstring = "'s spine is extracted by ";
							deathstring2 = "'s sentry gun.\n";
						}
					}
#ifdef mtf_coop
local entity te;
				if (targ.is_monster != 1 && attacker.is_monster == 1 || attacker.classname == "monster_boss") {
	te = find ( world, classname, "monster_score" );
	if (te.netname == "Monsters") {
		te.frags += 1;
		svcUpdateFrags (te.fClientNo, te.frags);
	}
				}
#ifdef mtf_coop_expsys
	if (attacker.real_owner.coop_exp != -1 && attacker.real_owner.classname == "player" && targ.is_monster == 1) {
		//attacker.real_owner.coop_exp = attacker.real_owner.coop_exp + 5;
		MTF_Coop_AddExperience ( attacker.real_owner, targ, FALSE );
		MTF_Coop_PreWriteExperience( attacker.real_owner, attacker.real_owner.connect_name, attacker.real_owner.coop_exp );
	}
#endif
					if (targ.is_monster)
						bprint(TF_FLARE_OFF, GetMonsterPowers(targ, 0));
#endif
					bprint(TF_FLARE_OFF, targ.netname);
					bprint(TF_FLARE_OFF, deathstring);
					bprint(TF_FLARE_OFF, attacker.real_owner.netname);
					bprint(TF_FLARE_OFF, deathstring2);
				}
			}
			else
			{
				logfrag(targ, targ);
#ifdef mtf_coop
				if (attacker.is_monster != 1)
					targ.real_frags = targ.real_frags - TF_FLARE_OFF;
#else
				targ.real_frags = targ.real_frags - TF_FLARE_OFF;
#endif
				if (!(toggleflags & 128))
				{
					targ.frags = targ.real_frags;
				}
				rnum = targ.watertype;
#ifdef mtf_coop
				if (targ.is_monster == 1)
					bprint(2, GetMonsterPowers(targ, 1));
				else
#endif
				bprint(2, targ.netname);
				if (rnum == -3)
				{
					if (random() < 0.5)
					{
						deathstring = " can't swim worth a crap!\n";
					}
					else
					{
						deathstring = " can't breathe water.\n";
					}
				}
				else
				{
					if (rnum == -4)
					{
						if (random() < 0.5)
						{
							deathstring = " gulped a load of Texas trucker mattress squeezings.\n";
						}
						else
						{
							deathstring = " can't exist on Mt. Dew alone.\n";
						}
					}
					else
					{
						if (rnum == -5)
						{
							if (targ.health < -15)
							{
								deathstring = " burst into flames.\n";
							}
							else
							{
								if (random() < 0.5)
								{
									deathstring = " turned into hot slag.\n";
								}
								else
								{
									deathstring = " visits the Hell fires.\n";
								}
							}
						}
						else
						{
							if (attacker.classname == "monster_dog")
							{
								deathstring = " was mauled by a Rottweiler.\n";
							}
							else
							{
								if (attacker.classname == "explo_box")
								{
									deathstring = " blow'd up.\n";
								}
								else
								{
									if (attacker.solid == 4 && attacker != world)
									{
										deathstring = " was crushed.\n";
									}
									else
									{
										if (targ.deathtype == "falling")
										{
											targ.deathtype = "";
											deathstring = " fell to his death.\n";
										}
										else
										{
											if (attacker.classname == "trap_shooter" || attacker.classname == "trap_spikeshooter")
											{
												deathstring = " was shot.\n";
											}
											else
											{
												if (attacker.classname == "fireball")
												{
													deathstring = " ate a lavaball.\n";
												}
												else
												{
												if (deathmsg == 69)
												{
													deathstring = " tried to ride a meteor\n";
												}
												else
												{
												if (deathmsg == 59)
												{
													deathstring = " caught a chunk of shrapnel.\n";
												}
												else
												{
													if (attacker.classname == "trigger_changelevel")
													{
														deathstring = " tried to leave.\n";
													}
#ifndef mtf_coop
													if (attacker.classname == "monster_shambler")
													{
														deathstring = " was shambled baby!\n";	
													}
#endif


													else
													{
#ifdef mtf_coop

														if (attacker.classname == "func_monsterkill") {
															if (attacker.netname_broadcast != "none")
																deathstring = attacker.netname_broadcast;
														}
														else if (targ.classname != "player") {
															if (random() > .5) {	
																deathstring = strcat(" died in an unfortunate gardening accident (", attacker.classname);
																deathstring = strcat(deathstring, ")\n");
															}
															else if (random() > .5) {
																deathstring = strcat(" flew into a wall and went splat :(  (", attacker.classname);
																deathstring = strcat(deathstring, ")\n");
															}
															else if (random() > .5) {
																deathstring = strcat(" drove his chevy THROUGH the levy (", attacker.classname);
																deathstring = strcat(deathstring, ")\n");
															}
															else {
																deathstring = strcat(" got a BSOD (", attacker.classname);
																deathstring = strcat(deathstring, ")\n");
															}
														}
														else
															deathstring = " died.\n";
#else
														deathstring = " died.\n";
#endif
													}
												} } }
											}
										}
									}
								}
							}
						}
					}
				}
#ifdef mtf_coop
				if (targ.is_monster != 1 && attacker.is_monster == 1 || attacker.classname == "monster_boss") {
	te = find ( world, classname, "monster_score" );
	if (te.netname == "Monsters") {
		if (targ.deathtype != "monster_respawn") {
			te.frags += 1;
			svcUpdateFrags (te.fClientNo, te.frags);
		}
	}
				}
				if (targ.deathtype == "monster_respawn") {
					deathstring = strcat(" was telefragged by a ", GetMonsterPowers(attacker, 2));
					targ.deathtype = string_null;
				}
				else if (targ.deathtype == "monster_respawn") {
					deathstring = attacker.netname_broadcast;
					targ.deathtype = string_null;
				}
				else if (attacker.classname == "monster_army")
					deathstring = strcat(" was shot by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_demon1")
					deathstring = strcat(" was eviscerated by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_dog")
					deathstring = strcat(" was mauled by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_dragon")
					deathstring = strcat(" was fried by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_enforcer")
					if (attacker.weapon & 16)//#MWEAPON_SNIPER)
						deathstring = strcat(" was blasted by a ", GetMonsterPowers(attacker, 2));
					else
						deathstring = strcat(" was blasted by an ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_fish")
					deathstring = strcat(" was fed to the ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_hell_knight")
					deathstring = strcat(" was slain by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_knight")
					deathstring = strcat(" was slashed by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_ogre" || attacker.classname == "monster_ogre_marksman")
					deathstring = strcat(" was destroyed by an ", GetMonsterPowers(attacker, 2));

				else if (attacker.classname == "monster_boss")
					deathstring = " burns in the flames of chthon\n";
				else if (attacker.classname == "monster_killable_boss")
					deathstring = " burns in the flames of uber chthon\n";

				else if (attacker.classname == "monster_oldone")
					deathstring = " became one with Shub-Niggurath\n";

				else if (attacker.classname == "monster_shalrath")
					deathstring = strcat(" was exploded by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_shambler")
					deathstring = strcat(" was smashed by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_tarbaby")
					deathstring = strcat(" was slimed by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_vomit")
					deathstring = strcat(" was vomited on by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_wizard")
					deathstring = strcat(" was scragged by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_zombie")
					deathstring = strcat(" joins the ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_azoth")
deathstring = strcat(" was vanquished by ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_vermis")
deathstring = strcat(" was eradicated by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_spider")
deathstring = strcat(" was desiccated by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_juggernaut")
deathstring = strcat(" was crushed by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_ubs")
deathstring = strcat(" was uberscragged by an ", GetMonsterPowers(attacker, 2));
				if ((attacker.classname == "monster_gaunt"))
				{
					if ((attacker.enemy.deathtype == "swoop"))
					{
						deathstring = strcat(" died in the clutches of a ", GetMonsterPowers(attacker, 2));
					}
					else
					{
						deathstring = strcat(" was charred by a ", GetMonsterPowers(attacker, 2));
					}
				}
				else if (attacker.classname == "monster_voreling")
					deathstring = strcat(" was violated by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_deathguard")
					deathstring = strcat(" was slaughtered by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_death_lord")
					deathstring = strcat(" was executed by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_polyp")
					deathstring = strcat(" was popped by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_drole")
					deathstring = strcat(" was decimated by a ", GetMonsterPowers(attacker, 2));

				else if (attacker.classname == "monster_gug")
					deathstring = strcat(" was obliterated by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.classname == "monster_bob")
					deathstring = strcat(" was zapped by a ", GetMonsterPowers(attacker, 2));
#endif

#ifdef mtf_coop_hipnotic

            else if (attacker.classname == "monster_gremlin")
deathstring = strcat("  was outsmarted by a ", GetMonsterPowers(attacker, 2));
            else if (attacker.classname == "monster_scourge")
deathstring = strcat(" was stung by a ", GetMonsterPowers(attacker, 2));

            else if (attacker.classname == "monster_armagon")
deathstring = strcat(" was outgunned by ", GetMonsterPowers(attacker, 2));
            else if (attacker.classname == "trap_spike_mine")
deathstring = strcat(" was blasted by a ", GetMonsterPowers(attacker, 2));
#endif
#ifdef mtf_coop_rogue
				else if ((attacker.classname == "monster_eel"))
				{
deathstring = strcat(" was electrified by an ", GetMonsterPowers(attacker, 2));
				}
				else if ((attacker.classname == "monster_wrath"))
				{
deathstring = strcat(" was disintegrated by a ", GetMonsterPowers(attacker, 2));
				}
				else if ((attacker.classname == "monster_super_wrath"))
				{
deathstring = strcat(" was obliterated by an ", GetMonsterPowers(attacker, 2));
				}
				else if ((attacker.classname == "monster_sword"))
				{
deathstring = strcat(" was slit open by a ", GetMonsterPowers(attacker, 2));
				}
				else if ((attacker.classname == "monster_lava_man"))
				{
deathstring = strcat(" fries in the fury of ", GetMonsterPowers(attacker, 2));
				}
				else if ((attacker.classname == "monster_morph"))
				{
deathstring = strcat(" was crushed by a ", GetMonsterPowers(attacker, 2));
				}
				else if ((attacker.classname == "monster_mummy"))
				{
deathstring = strcat(" was was mummified by a ", GetMonsterPowers(attacker, 2));
				}

#endif
#ifdef mtf_coop
				else if (attacker.classname == "monster_cyberdemon")
					deathstring = strcat(" was shot into Doom II by a ", GetMonsterPowers(attacker, 2));
				else if (attacker.netname != "" && attacker != world && deathstring == " died.\n")
				{
					deathstring = GetMonsterDeathstring(attacker.classname);
					deathstring = strcat(deathstring, GetMonsterPowers(attacker, 2));
				}
				else if (deathstring == " died\n") {
					deathstring = frik_strcat(" met an uncertain fate (", attacker.classname, ")\n");
					targ.ammo_cells = 666;	// hackish, but so we know the player died by a trigger_hurt for survival mode dummy
				}
#endif
				bprint(TF_FLARE_OFF, deathstring);
			}
		}
	}
	else
	{
		if (((targ.classname == "building_sentrygun") || (targ.classname == "building_tesla")))
		{
			if ((attacker.classname == "teledeath"))
			{
				bprint (TF_FLARE_OFF, targ.real_owner.netname);
				bprint (TF_FLARE_OFF, "'s sentrygun was telefragged by ");
				bprint (TF_FLARE_OFF, attacker.owner.netname);
				bprint (TF_FLARE_OFF, "\n");
				return;
			}
			if ((attacker.classname == "player"))
			{
				if ((attacker == targ.real_owner))
				{
					bprint (TF_FLARE_OFF, targ.real_owner.netname);
					bprint (TF_FLARE_OFF, " self destructs his sentrygun.\n");
					return;
				}
				bprint (TF_FLARE_OFF, targ.real_owner.netname);
				if ((targ.classname == "building_sentrygun"))
				{
					bprint (TF_FLARE_OFF, "'s sentrygun was no match for ");
				}
				else
				{
					bprint (TF_FLARE_OFF, "'s tesla coil was no match for ");
				}
				bprint (TF_FLARE_OFF, attacker.netname);
				bprint (TF_FLARE_OFF, ".\n");
				logfrag (attacker, targ.real_owner);
				if (((attacker.team_no > TF_FLARE_LIT) && (attacker.team_no != targ.real_owner.team_no)))
				{
					attacker.real_frags = (attacker.real_frags + TF_FLARE_OFF);
					logfrag (attacker, targ.real_owner);
					if (!(toggleflags & 128))
					{
						attacker.frags = attacker.real_frags;
					}
				}
				return;
			}
		}
	}
};

void(entity attacker) fertimer = 
{
	attacker.fertracker = 1;
	newmis = spawn();
	newmis.enemy = attacker;
	newmis.classname = "timer";
	newmis.nextthink = time + 3;
	newmis.think = ferdisplay;
};
void(entity te) ferdisplay =
{
	local entity playernamefer;
	playernamefer = self.enemy;
	playernamefer.fertracker = 0;
	if (playernamefer.classname == "monster_shambler")
	{
#ifndef mtf_coop
		playernamefer.netname = "The Shambler";
#endif
	}
#ifdef mtf_coop
	if (playernamefer.is_monster != 1 && playernamefer.classname != "player" && playernamefer.netname != "The Shambler")
#else
	if (playernamefer.classname != "player" && playernamefer.netname != "The Shambler")
#endif
	{
		dremove (self);
		return;
	}
	if (playernamefer.num_kills > 1)
	{
		local string fercount;
		fercount = ftos(playernamefer.num_kills);
		bprint (1.000000, playernamefer.netname);
		bprint (1.000000, " got a ");
		bprint (1.000000, fercount);
		bprint (1.000000, "-fer!");
		bprint (1.000000, "\n");
#ifdef mtf_coop_achievements
		if (playernamefer.classname == "player")
			Achievements_Change( playernamefer, world, ACHIEVEMENTS_ADD, ACHIEVEMENT_MULTI, 1 );
#endif
		if (playernamefer.num_kills < 1336)
			Record_Check(playernamefer, playernamefer.num_kills, #RECORD_FER);
		playernamefer.num_kills = 0;
		playernamefer.hookpoints = 0;
		if (FTE_Server)
			Rank_AddFers(playernamefer, 1);
	}
	playernamefer.num_kills = 0;
	playernamefer.hookpoints = 0;
	dremove (self);
};
void(entity targ) teamchangetimer = 
{
	self.wait = 1;
	newmis = spawn();
	newmis.enemy = targ;
	newmis.classname = "timer";
	newmis.nextthink = time + .5;
	newmis.think = teamchange;
};
void(entity targeh) teamchange = 
{
	local entity targ;
	targ = targeh;
	if (self.enemy)
	{
		targ = self.enemy;
	}
	if (targ.team_no == 1) { teamcount1 = teamcount1 - 1; }
	if (targ.team_no == 2) { teamcount2 = teamcount2 - 1; }
	if (targ.team_no == 3) { teamcount3 = teamcount3 - 1; }
	if (targ.team_no == 4) { teamcount4 = teamcount4 - 1; }
		if (targ.ischangingteams == 1)	{
		targ.team_no = 1;
		teamcount1 = teamcount1 + 1;
		stuffcmd (targ, "color 13");
		stuffcmd (targ, "\n");
		stuffcmd (targ, "team blue");
		stuffcmd (targ, "\n");
		targ.ischangingteams = 0; }
		if (targ.ischangingteams == 2)	{
		teamcount2 = teamcount2 + 1;
		targ.team_no = 2;
		stuffcmd (targ, "color 4");
		stuffcmd (targ, "\n");
		stuffcmd (targ, "team red");
		stuffcmd (targ, "\n");
		targ.ischangingteams = 0; }
		if (targ.ischangingteams == 3)	{
		targ.team_no = 3;
		teamcount3 = teamcount3 + 1;
		stuffcmd (targ, "color 12");
		stuffcmd (targ, "\n");
		stuffcmd (targ, "team yellow");
		stuffcmd (targ, "\n");
		targ.ischangingteams = 0; }
		if (targ.ischangingteams == 4)	{
		targ.team_no = 4;
		teamcount4 = teamcount4 + 1;
		stuffcmd (targ, "color 11");
		stuffcmd (targ, "\n");
		stuffcmd (targ, "team green");
		stuffcmd (targ, "\n");
		targ.ischangingteams = 0; }
	dremove (self);
};
void () FixSoundCrap =
{
	local entity playername;
	playername = self.enemy;
	stuffcmd (playername, "_snd_mixahead .1\n");
	dremove (self);
};
void() attachplayerfob =
{

local entity playerfob;
	playerfob = spawn();
	playerfob.classname = "player_teamfob";
	playerfob.owner = self;
	playerfob.real_owner = self;
	playerfob.health = 999;		
	playerfob.armorvalue = time + playerfob.health;
	playerfob.think = playerfob_think;
	playerfob.nextthink = time + .1;
	playerfob.velocity = self.velocity; // move at the same rate as player. ?
	playerfob.team_no = self.team_no; //Same team number as the player -arg
	playerfob.origin = self.origin + '0 0 50'; //put fob above the player.
	playerfob.touch = SUB_Null; // it does nothing, if touched.
	self.playerfob_target = self; // for following with beartrap logic code.
	setmodel (playerfob, "progs/newdot.spr");
	playerfob.frame = self.team_no - 1; //color fob dot same as player's team color. except green team is a purple dot. go figure. maybe a new sprite someday. -arg
//end playerfob added -arg
};
void () playerfob_think =
{
	if (self.disconnectPlayer || self.deadflag)
	{
		remove (self); //self as defined within playerfob //dissapear with player if they die or disconnect. -arg
		return;
	}
	if (self.owner.owner != self.real_owner)  //from summon_think for goalie. -arg
		{
		self.owner.owner = self.real_owner;
		}
	if (self.owner.is_feigning)		//if you are a spy feigning don't advertise with a dot
		{
		remove(self);  //self being the playerfob.
		return;
		}
	if (self.owner.invisible_time > time)
		{
		remove(self);		// remove fob if you are invisible.
		return;
		}
	local float fls, mhp;
	local vector endp;
	fls = self.owner.maxs_z * 1;
	endp = self.owner.origin;
	endp_z += fls;
	if (endp == self.orig_origin)	// save some bandwidth player is not moving
	{
		self.nextthink = time + .1;
		return;
	}
//move with player.
	if (self.origin != self.playerfob_target.origin || self.angles != self.owner.angles)
	{
	setorigin (self, (self.playerfob_target.origin));
	}
	if (self.angles != self.owner.angles) //follow in 3D space like the beartrap :} -arg
	{
			self.angles = self.owner.angles;
	}
	self.orig_origin = endp;
	setorigin(self, endp);
	self.frame = self.owner.team_no - 1; //always display the color as the player's team color.
	if (self.owner.is_undercover == 2)
		{
		self.frame = self.owner.undercover_team - 1 ;   //if you are a spy undercover, change the color to match -arg
		}
	self.nextthink = time + .1;
};
//End